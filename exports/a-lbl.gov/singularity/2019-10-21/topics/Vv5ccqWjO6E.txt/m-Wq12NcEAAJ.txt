X-Received: by 2002:a17:902:a9c8:: with SMTP id b8mr2752544plr.58.1548088072202;
        Mon, 21 Jan 2019 08:27:52 -0800 (PST)
X-BeenThere: singularity@lbl.gov
Received: by 2002:a63:618a:: with SMTP id v132ls8600561pgb.6.gmail; Mon, 21
 Jan 2019 08:27:51 -0800 (PST)
X-Received: by 2002:a62:e0d8:: with SMTP id d85mr29750834pfm.214.1548088071033;
        Mon, 21 Jan 2019 08:27:51 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1548088070; cv=none;
        d=google.com; s=arc-20160816;
        b=hkH5CzyyvuvJdSP2tSw9TnPgz9Ler5vlvPEeAY+G8hZr+CksRAW2lVczNbTW0nSDZG
         wGbQtx2vK6/3u2KqPx/zzvAOtxre+zgFkaMLIBPwMUFFTbQOkUL5HOUFdx+gTBVgoJWG
         WSHN+BbIuFCU2ojQi0Xq5i9wTrEiu+eFy9ZESYbzFltrSA3QedEzWXL+i0DOzlJ8IPhI
         PeEl0UV6Hns5UNBa6MPPn8LVt94E05yZ7KDsOOq6tk69YkKog7RSbTZt+62scKPan8eo
         jJs0cA3r4NPKl8MSXNqQKsqVgxwPBMUN6wqZ0Wu9yG6DQAwn4QTWoJrZ2y+vGUJw4vFZ
         cWUg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=to:subject:message-id:date:from:in-reply-to:references:mime-version
         :dkim-signature;
        bh=BxKIkOvOt1MfL04BGNQjLo1wikTIyg1PKoR5gf4yfPU=;
        b=VeGrc+VmdhshmGjz0itw/CzNpgiphdfakfXN7aejLn84MN3OVaqsMBarOQPcqiD9Bk
         F2PKho9ap5EOeSkGpMeekVvdXcSS4Kr3EiTpMrLdEyqcUOzZbrZ4iNP7ZYoRU25aaqAz
         5nD0u1UjB/Q2iHRIw86Bke4xaBpAqnSWBDdsxCgVIAxCceCL0tZHlwgG8q1DGk9U7a1u
         MVDW1tbsHXunlG/7mBnSPo88YfbXazpKg2GaFc6MggtqK8/NoFs6/UEU8u6D2OC/PI00
         PIvhJLM3eiGHZFkJp1TAR/YVlcQ46xm7fCoTbfKaIB0G8hpv8qUqIZHGMetXixLsyQHP
         ZmYA==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass head...@gmail.com header.s=20161025 header.b=f77TNGH1;
       spf=pass (google.com: domain of deank...@gmail.com designates 209.85.167.50 as permitted sender) smtp.mailfrom=deank...@gmail.com
Return-Path: <deank...@gmail.com>
Received: from fe3.lbl.gov (fe3.lbl.gov. [131.243.228.52])
        by mx.google.com with ESMTP id m187si12965779pfm.51.2019.01.21.08.27.50
        for <singu...@lbl.gov>;
        Mon, 21 Jan 2019 08:27:50 -0800 (PST)
Received-SPF: pass (google.com: domain of deank...@gmail.com designates 209.85.167.50 as permitted sender) client-ip=209.85.167.50;
Authentication-Results: mx.google.com;
       dkim=pass head...@gmail.com header.s=20161025 header.b=f77TNGH1;
       spf=pass (google.com: domain of deank...@gmail.com designates 209.85.167.50 as permitted sender) smtp.mailfrom=deank...@gmail.com
X-Ironport-SBRS: 3.5
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A2EkAAC48UVchzKnVdFaCBwBAQEEAQEHB?=
 =?us-ascii?q?AEBgVIGAQELAYENAUyBD4ECJ4N7BoEdgi0xkAaCDZgBFIEQAxgXIQQlAQwJgQK?=
 =?us-ascii?q?CdkYCgmIiNQgNAQMBAQIBAQIBAQIQAQEBCA0JCCkjDII6BQIDAiQKBE06AS8BA?=
 =?us-ascii?q?QEBAQEBAQEBAQEBAQEBAQEBAQEBFAIMASAGPQEBAQECAQ4MCR0BBwYOCRUDAQs?=
 =?us-ascii?q?GBQsKAxULAQkCAiEBAQ4DAQUBCxEOBwQBHASDAQEnAYFAAQMNCAUKn2E8ixuBE?=
 =?us-ascii?q?gUBF4J4BVUgPAETQYIvChknDV6BNwIGEowvF4FAP4ERgxKCV0cBAYEbARIBDQU?=
 =?us-ascii?q?BCEQSgkqCVwKCI4ceD4EUhn6Ef4sMMwmCMoRyhz6DORiBZk6EYIM4h0iLDIQUg?=
 =?us-ascii?q?RiHCgGDSzCBJgFsMHEzGiOBAYIHAQEyCYISDA4Jg0uFFIE9hARAMAEBDog4R4F?=
 =?us-ascii?q?hFgEB?=
X-IronPort-AV: E=Sophos;i="5.56,503,1539673200"; 
   d="scan'208,217";a="141076025"
Received: from mail-lf1-f50.google.com ([209.85.167.50])
  by fe3.lbl.gov with ESMTP; 21 Jan 2019 08:27:47 -0800
Received: by mail-lf1-f50.google.com with SMTP id b20so15907559lfa.12
        for <singu...@lbl.gov>; Mon, 21 Jan 2019 08:27:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to;
        bh=BxKIkOvOt1MfL04BGNQjLo1wikTIyg1PKoR5gf4yfPU=;
        b=f77TNGH140xgbTMEEP/v0q5lBLbU/4jiGur81QGdz/l4Y/lEHJmJmA9RF491iXDjOw
         Aj5hZhfpTaChRVJeUi53WY6EP49b7JDq/HppHYBQZtUNdakSsjeSkPSNV7apWGW+qirr
         l1NACu8EIG6etqwIU8Lz+D5OrmghIKeQOsK90CuYxNaXsmT9AkcYJYk4l+zLKmyw/xHe
         sEYPS22j6dRqKzRbBmhNq+D5Vy6cEHLAb1JTYpcdxP7T5CeXIaQfM1dZNyGRjeV7hsEu
         G79Ny6VhtoL/FKiYLHmXj6CvHwckGx2XqofQwdu5xfzUzPQPqyiuqsTEc4QwG5LW0MQ3
         Qh3Q==
X-Gm-Message-State: AJcUukdP+KWRNOeSLvONNp0Lv2YVL1aBWDUxmZApDpKqElSv7RS0PTYM
	YVJoYbZ7jSUePlN2f+yIUAUZYRJNuF8AwmQtrKwgCEyH
X-Received: by 2002:a19:d242:: with SMTP id j63mr19626601lfg.26.1548088065704;
 Mon, 21 Jan 2019 08:27:45 -0800 (PST)
MIME-Version: 1.0
References: <9310c07c-393a-423f-9e83-18bd07c9c099@lbl.gov> <67e60139-1082-4915-bced-c766eafc96f2@lbl.gov>
 <CAPqNE2XXe3a7jnL90xB+zJN1DCif7SPRf6nWqunKvZ1Ntqw8xA@mail.gmail.com>
 <f8dd49b5-1663-4930-8756-5d33321839ec@lbl.gov> <CAPqNE2Xe6q0_RXfC4SWQHR4_j1bYTnBwVx+ivgSDZj28timZpA@mail.gmail.com>
 <CAPqNE2WQk+Tv4nNumSBjcje_UM+XEx-o8fT1VugHwgFCEErkwQ@mail.gmail.com>
 <CAPqNE2XMG5vgQv=noBJf7wCr7S49ze0C51yt1mo9+T-vysWY-g@mail.gmail.com>
 <CAPqNE2W0tSb=YRCcCpd11kSTERbtLN=VGTG3zeBdx4kECcqpVQ@mail.gmail.com>
 <a6050ea3-8ae3-4621-8b9b-ee98cd10d30b@lbl.gov> <CAPqNE2Ws_ApOCQNBQM9adurgSbmfK2nmpLArz6PMvC3opH167Q@mail.gmail.com>
 <CALOeK_cM09CNBZ5PBHb5yBYdckab1j3OiGVUrRg1g16Nwdosww@mail.gmail.com>
 <CAPqNE2XPtMwtzN_wQihuTJ_yLeZLXHubS+iGNmm=kqXQgFVcdw@mail.gmail.com>
 <CALOeK_fz-HWgJigGhP_kdm7PKEtjeyEv658R03C8Q-=GXZ_Ztg@mail.gmail.com> <CAPqNE2Wg0GpQXRg65c9cXW0GKfaw7Ri0gW6kgUjDqy4=MCqC2w@mail.gmail.com>
In-Reply-To: <CAPqNE2Wg0GpQXRg65c9cXW0GKfaw7Ri0gW6kgUjDqy4=MCqC2w@mail.gmail.com>
From: Dean Kayton <deank...@gmail.com>
Date: Mon, 21 Jan 2019 18:27:33 +0200
Message-ID: <CAGQ-A5q30YdLf4a_PZMPTT34asbNx-xBiAHJPHOCHOO8BgtEsg@mail.gmail.com>
Subject: Re: [Singularity] Re: Permission denied accessing certain packages
To: singularity@lbl.gov
Content-Type: multipart/alternative; boundary="0000000000003ccec6057ffa57e7"

--0000000000003ccec6057ffa57e7
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

Hi all,


I found that relying on the .julia folder (even if using an
alternate JULIA_PKGDIR) was at odds with what containerisation stands for.
And it meant I had to think of a new path for JULIA_PKGDIR so as not to
interfere with the packaging system of my host's Julia install.

I would still like a way to have all of the stuff that would be in the
JULIA_PKGDIR to be built within an image for reproduce-ability... but my
workaround was to get the script to create a tar archive of everything at
build time, and upon setting a pre-defined environment variable, give the
ability to reset things to how they were at build time.


Here is an example def and scripts to accompany.




project.def

Bootstrap: docker
From: julia:0.6.4

%setup
    # Optional, move a copy of the repo I am interested in, into the
container (makes things portable for my users who are not modifying
code)
    su - $(logname) -c "git clone ${PROJECT_REPO_URL} -b
${PROJECT_REPO_BRANCH} ${PROJECT_REPO_LOCATION}" # I do this because
git is setup as my user, not root
    chown -R root:root ${PROJECT_REPO_LOCATION}
    chmod -R 0755 ${PROJECT_REPO_LOCATION}
    mv ${PROJECT_REPO_LOC} ${SINGULARITY_ROOTFS}/${PROJECT_REPO_NAME}

%post
    # Install build tools as others have suggested
    apt-get update; apt-get -y install build-essential bzip2 libexpat1-dev

%environment
    # See environment.sh script below
    . /${PROJECT_REPO_NAME}/singularity/environment.sh  # Need to use
the literal path here (I have this script as part of the repo which as
described in %setup, is
                                                        # copied into
the container)

%runscript
    exec ${PROJECT_REPO_NAME}/singularity/runscript.sh "$@"  # Can use
a variable defined in %environment here

environment.sh

#!/bin/sh

# Singularity uses #!/bin/sh for %environment section, so when sourcing the=
se
# environment variables, be aware of syntax
# Also note that environment script is baked into the image, so a rebuild i=
s
# required after each change

: ${PROJECT_RESET:=3D0}
export PROJECT_RESET
export PROJECT_CONFIG_DIR=3D${HOME}/.project/config
mkdir -p ${PROJECT_CONFIG_DIR}

if [ ! -f ${PROJECT_CONFIG_DIR}/.firstrun ]; then
    PROJECT_HOMEDIR_DEFAULT=3D"${HOME}/.project"
    read -p "Please enter PROJECT_HOMEDIR
[${PROJECT_HOMEDIR_DEFAULT}]: " PROJECT_HOMEDIR
    PROJECT_HOMEDIR=3D"${PROJECT_HOMEDIR:-$PROJECT_HOMEDIR_DEFAULT}"

    export PROJECT_HOMEDIR; echo ${PROJECT_HOMEDIR} >
${PROJECT_CONFIG_DIR}/.home  # From now on PROJECT_HOMEDIR is read
from this file
    touch ${PROJECT_CONFIG_DIR}/.firstrun  # This ensures that this
block of code is only run the first time
else
    export PROJECT_HOMEDIR=3D$(cat ${PROJECT_CONFIG_DIR}/.home)
fi

export PROJECT_PKGDIR=3D${PROJECT_HOMEDIR}/pkg
export PROJECT_TARPATH=3D${PROJECT_HOMEDIR}/pkg.tar.gz
export JULIA_PKGDIR=3D${PROJECT_PKGDIR}/.julia

runscript.sh

#!/bin/bash -eu

if [[ ${PROJECT_RESET} -eq 1 ]]; then
    rm -rf ${PROJECT_PKGDIR}
    mkdir -p ${PROJECT_PKGDIR}
    tar -xzf ${PROJECT_TARPATH} -C ${PROJECT_PKGDIR}
else
    if [[ ! -d ${PROJECT_PKGDIR} ]]; then

        # This is where, on first run all of the Julia package
building takes place. Note, you cannot move the artifacts and these
artifacts
        # will be owned by the user running the container. Sub in your
own Julia packages here.

julia -e ' \ Pkg.init(); Pkg.update(); \
Pkg.clone("https://github.com/HIVDiversity/NextGenSeqUtils.jl"); \
Pkg.checkout("NextGenSeqUtils", "dev"); \
using NextGenSeqUtils; \
'
cd ${PROJECT_PKGDIR}
rm -f ${PROJECT_TARPATH}
export GZIP=3D-9; tar -czf ${PROJECT_TARPATH} .
fi
fi
exec ${PROJECT_REPODIR}/src/somescript.sh "$@"


Don't know if this helps or not.

I wish that I was able to ship what is currently locked in the tar, in the
image itself. That way, no matter which user you are... you have a copy of
everything required to go. Because with the above, in a multi-user linux
system, each user has to do the above and each user has a seperate copy of
the same Julia packages (that could be slightly different given the date
they complete the first run).

Containerisation is supposed to avoid this kind of source for
irreproducability.


What are your thoughts? Is there a mechanism by which I can do the above in
a more satisfactory way?




Kind regards,
Dean





On Mon, Jan 21, 2019 at 4:54 PM 'John Hearns' via singularity <
singu...@lbl.gov> wrote:

> Tim, thankyou for the update.
> This is not the place for me to comment on Julia, however I will and
> apologise to anyone getting bored with this.
> 0.6 was supposed to be followed by 0.7 which had deprecation warnings.
> Package owners were supposed to test with 0.7
> Then 1.0 should have been introduced.
> As you have seen significant packages are still to catch up.
> We are promised failtfully that there will be no breaking cahnges in the
> 1.x series so here is hoping that things settle down.
>
>
>
>
> On Sat, 19 Jan 2019 at 16:47, Tims Corbett <tims....@gmail.com> wrote:
>
>> Thanks John. It strikes a balance and serves my purpose.
>>
>> I have to provide both 0.6.4 and 0.1.
>> Knitro package has some compatibility issues with Julia 1.0.
>>
>> So here are the steps:
>>
>> 1. build a plain singularity image with julia base. set the JULIA_PKGDIR
>> (pointing to host to bind later) in %environment
>> 2. run the following to install new packages and force precompile on the=
m
>>
>> julia --version
>> julia -e 'Pkg.resolve()'
>> sudo cat /.julia/v0.6/REQUIRE | xargs --verbose -I '{}' bash -c "julia -=
e
>> 'using {}'"
>>
>> 3. create containers as needed
>>
>> singularity exec -B /.julia/ ./intelmpi-julia0.6.4.simg julia -e "using
>> Complementarity"
>> singularity exec -B /.julia/ ./intelmpi-julia0.6.4.simg julia -e "using
>> Ipopt"
>>
>> The catch is that bind inside and outside paths must be exactly the same
>> (no aliases).
>>
>> Thanks again!
>>
>>
>> On Sat, Jan 19, 2019 at 2:11 AM 'John Hearns' via singularity <
>> singu...@lbl.gov> wrote:
>>
>>> Tim,  I think you need to put in a mount for your home directory.
>>> Also with Julia if you add packages as the root user these are personal
>>> to the root user.
>>> Packages live under .julia in your account - but this is just the
>>> default.
>>> You can have system wide Julia packages, but you then have to set
>>> JULIA_HOME
>>> See https://docs.julialang.org/en/v0.6.0/manual/environment-variables/
>>>
>>> If you use the Modules system you can have a Module set these - and als=
o
>>> have different versions of Julia on your system.
>>>
>>> Also, above, I was talking about running the same version of Julia on a
>>> system wide command line and installing packages,
>>> which are then 'picked up' when the container is run and mounts your
>>> home dir.
>>> Before anyone says it, this defeats the purpose of containers.
>>> However Julia can mix 0.6 and 1.0 ec. versions in your .julia
>>>
>>>
>>>
>>>
>>>
>>>
>>> On Sat, 19 Jan 2019 at 06:20, Tims Corbett <tims....@gmail.com>
>>> wrote:
>>>
>>>> Here's the recipe, good night
>>>>
>>>> Bootstrap: docker
>>>> From: julia:0.6.4
>>>>
>>>>
>>>> %post
>>>> apt-get update
>>>> apt-get install -y build-essential
>>>> apt-get install -y wget
>>>> apt-get install -y gfortran
>>>> apt-get install -y hdf5-tools
>>>>
>>>> export JULIA_PKGDIR=3D/root/.julia/
>>>>
>>>> julia -e 'Pkg.init(); Pkg.update();
>>>> Pkg.add.(["CSV","GLPK","DataStreams","FunctionWrappers","KNITRO","Cond=
itionalJuMP","Missings","Ipopt","MAT","DataArrays","GLPKMathProgInterface",=
"DataFrames","PATHSolver",
>>>> "Complementarity"]); Pkg.build()'
>>>>
>>>> sed -i '1270 s/^/#/' /root/.julia/v0.6/JuMP/src/nlp.jl
>>>> sed -i '1280 s/^/#/' /root/.julia/v0.6/JuMP/src/nlp.jl
>>>>
>>>> julia --version
>>>>
>>>> %environment
>>>> SHELL=3D/bin/bash
>>>>
>>>> PATH=3D/usr/local/julia/bin/julia:$PATH
>>>> LD_LIBRARY_PATH=3D/usr/local/julia/lib/julia:$LD_LIBRARY_PATH
>>>>
>>>> export JULIA_PKGDIR=3D/root/.julia/
>>>>
>>>> ############### INSTRUCTIONS TO RUN ###############
>>>> #
>>>> # sudo singularity build --sandbox intelmpi-julia0.6.4.img
>>>> intelmpi-julia0.6.4.recipe
>>>> # sudo singularity build intelmpi-julia0.6.4.simg
>>>> intelmpi-julia0.6.4.img/
>>>>
>>>>
>>>> On Fri, Jan 18, 2019 at 10:05 PM 'John Hearns' via singularity <
>>>> singu...@lbl.gov> wrote:
>>>>
>>>>> Tim, I have to get some sleep.
>>>>> Could you give us the definition file for your container?
>>>>> I am being lazy and pulling the latest Julia container from Docker hu=
b.
>>>>>
>>>>> On Sat, 19 Jan 2019 at 05:51, Tims <tims....@gmail.com> wrote:
>>>>>
>>>>>> per your suggestion John, I am trying to install Ipopt from REPL.
>>>>>> So, first trying to remove Ipopt:
>>>>>>
>>>>>>  Pkg.rm("Ipopt")
>>>>>> INFO: Removing Ipopt v0.4.5
>>>>>> ERROR: sendfile: no space left on device (ENOSPC)
>>>>>>
>>>>>> Started REPL as:
>>>>>> singularity shell intelmpi-julia0.6.4.img/
>>>>>> julia
>>>>>>
>>>>>>
>>>>>>
>>>>>> On Friday, January 18, 2019 at 9:38:03 PM UTC-8, John Hearns wrote:
>>>>>>>
>>>>>>> Having said what I just said, running Julia 1.0.3 within the
>>>>>>> container I had to do Pkg.build("SpecialFunctions")
>>>>>>> Working OK now though  - curioser and curioser as Alice said.
>>>>>>>
>>>>>>> On Sat, 19 Jan 2019 at 05:31, John Hearns <h...@googlemail.com>
>>>>>>> wrote:
>>>>>>>
>>>>>>>> Also shirking responsibility here - the folks over at
>>>>>>>> https://discourse.julialang.org/ are pretty helpful.
>>>>>>>> I think you have pointed out a wrinkle regarding usign Julia in
>>>>>>>> containers - you need to either bring along a development environm=
ent, or
>>>>>>>> install things beforehand in your .julia
>>>>>>>>
>>>>>>>> On Sat, 19 Jan 2019 at 05:28, John Hearns <h...@googlemail.com>
>>>>>>>> wrote:
>>>>>>>>
>>>>>>>>> Going out on a bit of a limb here I think they way forward it to
>>>>>>>>>
>>>>>>>>> a) create a container with all the build tools which are needed
>>>>>>>>>
>>>>>>>>> b) run the Julia REPL from a normal shell, Pkg add and Pkg build
>>>>>>>>> all the packages you need
>>>>>>>>> Then when the container runs it should pick up everything from
>>>>>>>>> your .julia directory
>>>>>>>>> I may be wrong
>>>>>>>>>
>>>>>>>>> On Sat, 19 Jan 2019 at 05:25, John Hearns <h...@googlemail.com>
>>>>>>>>> wrote:
>>>>>>>>>
>>>>>>>>>> Hi Tim.
>>>>>>>>>> Why are you running as root? Is that necessary?
>>>>>>>>>>
>>>>>>>>>> When I try to add the Complementarity module in the version 1.0.=
3
>>>>>>>>>> container
>>>>>>>>>>
>>>>>>>>>> =E2=94=82 [ Info: Changing directory to
>>>>>>>>>> /home/hearnsj/.julia/packages/PATHSolver/xjazJ/deps/src/PathJuli=
a-0.1.2/src
>>>>>>>>>> =E2=94=82 ERROR: LoadError: IOError: could not spawn `make linux=
64`: no
>>>>>>>>>> such file or directory (ENOENT)
>>>>>>>>>> =E2=94=82 Stacktrace:
>>>>>>>>>>
>>>>>>>>>> I guess all that is saying is that 'make' is not installed int h=
e
>>>>>>>>>> container.
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> I guess you dont have command line Julia 0.6.4 installed on your
>>>>>>>>>> system.
>>>>>>>>>> Maybe worth installing that, and trying to add Complementarity
>>>>>>>>>> I thought I had 0.6 as an alternative on my system,  but sorry
>>>>>>>>>> seem to have deleted it
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> On Sat, 19 Jan 2019 at 04:50, Tims <ti...@gmail.com> wrote:
>>>>>>>>>>
>>>>>>>>>>> Thanks John, yes I need 0.6.4.
>>>>>>>>>>> The workaround I have is to chown and give wheel access to
>>>>>>>>>>> /root/.julia and then convert from sandbox to squashfs.
>>>>>>>>>>> It  works for package Compat.but breaks witha seg fault for
>>>>>>>>>>> package Complementarity.
>>>>>>>>>>>
>>>>>>>>>>> singularity exec intelmpi-julia0.6.4.img/ julia -e "using
>>>>>>>>>>> Complementarity"
>>>>>>>>>>>
>>>>>>>>>>> signal (11): Segmentation fault
>>>>>>>>>>> while loading /root/.julia/v0.6/ForwardDiff/src/ForwardDiff.jl,
>>>>>>>>>>> in expression starting on line 12
>>>>>>>>>>>
>>>>>>>>>>> Any clue?
>>>>>>>>>>>
>>>>>>>>>>>
>>>>>>>>>>>
>>>>>>>>>>> On Friday, January 18, 2019 at 8:30:22 PM UTC-8, John Hearns
>>>>>>>>>>> wrote:
>>>>>>>>>>>>
>>>>>>>>>>>> Hi Tim.  I guess you have good reasons for using Julia version
>>>>>>>>>>>> 0.6.4 - most probably because you have code which only runs wi=
th this
>>>>>>>>>>>> version, and hence why Compay.jl is being asked for also.
>>>>>>>>>>>>
>>>>>>>>>>>> Not very helpful of me, but using Singularity 3.0.2 I can pull
>>>>>>>>>>>> a Julia container from the Docker registry which has Julia 1.0=
.3
>>>>>>>>>>>>
>>>>>>>>>>>> singularity pull docker://julia
>>>>>>>>>>>> singularity exec julia_latest.sif  julia -e 'import Pkg;
>>>>>>>>>>>> Pkg.add("Compat"); using Compat'
>>>>>>>>>>>>
>>>>>>>>>>>> The .julia directory from my own account is being used - I can
>>>>>>>>>>>> add packages before execing the container also.
>>>>>>>>>>>> The extra Pkg stuff after -e is due to the new Julia package
>>>>>>>>>>>> manager, if anyone is wondering why. You have to pull Pkg in n=
ow as it is
>>>>>>>>>>>> not in Base AFAIK
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>> On Sat, 19 Jan 2019 at 02:21, Tims <ti...@gmail.com> wrote:
>>>>>>>>>>>>
>>>>>>>>>>>>> The image was built from a sandbox as
>>>>>>>>>>>>>
>>>>>>>>>>>>> sudo singularity build julia0.6.4.simg julia0.6.4.img/
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>> singularity exec intelmpi-julia0.6.4.simg julia -e 'using
>>>>>>>>>>>>> Compat'
>>>>>>>>>>>>>
>>>>>>>>>>>>> ERROR: SystemError: opening file
>>>>>>>>>>>>> /root/.julia/lib/v0.6/Compat.ji: Permission denied
>>>>>>>>>>>>> Stacktrace:
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>> On Friday, January 18, 2019 at 2:19:33 PM UTC-8, Tims wrote:
>>>>>>>>>>>>>>
>>>>>>>>>>>>>>
>>>>>>>>>>>>>> While running a singularity container, Julia is apparently
>>>>>>>>>>>>>> trying to precompile packages and running into permission er=
rors.
>>>>>>>>>>>>>>
>>>>>>>>>>>>>> ERROR: LoadError: LoadError: SystemError: opening file
>>>>>>>>>>>>>> /root/.julia/lib/v0.6/Compat.ji: Permission denied
>>>>>>>>>>>>>>
>>>>>>>>>>>>>>
>>>>>>>>>>>>>> What is a good way to avoid this error without sudo ing?
>>>>>>>>>>>>>>
>>>>>>>>>>>>> --
>>>>>>>>>>>>> You received this message because you are subscribed to the
>>>>>>>>>>>>> Google Groups "singularity" group.
>>>>>>>>>>>>> To unsubscribe from this group and stop receiving emails from
>>>>>>>>>>>>> it, send an email to singu...@lbl.gov.
>>>>>>>>>>>>>
>>>>>>>>>>>> --
>>>>>>>>>>> You received this message because you are subscribed to the
>>>>>>>>>>> Google Groups "singularity" group.
>>>>>>>>>>> To unsubscribe from this group and stop receiving emails from
>>>>>>>>>>> it, send an email to singu...@lbl.gov.
>>>>>>>>>>>
>>>>>>>>>> --
>>>>>> You received this message because you are subscribed to the Google
>>>>>> Groups "singularity" group.
>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>> send an email to singu...@lbl.gov.
>>>>>>
>>>>> --
>>>>> You received this message because you are subscribed to a topic in th=
e
>>>>> Google Groups "singularity" group.
>>>>> To unsubscribe from this topic, visit
>>>>> https://groups.google.com/a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/u=
nsubscribe
>>>>> .
>>>>> To unsubscribe from this group and all its topics, send an email to
>>>>> singu...@lbl.gov.
>>>>>
>>>> --
>>>> You received this message because you are subscribed to the Google
>>>> Groups "singularity" group.
>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>> an email to singu...@lbl.gov.
>>>>
>>> --
>>> You received this message because you are subscribed to a topic in the
>>> Google Groups "singularity" group.
>>> To unsubscribe from this topic, visit
>>> https://groups.google.com/a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/uns=
ubscribe
>>> .
>>> To unsubscribe from this group and all its topics, send an email to
>>> singu...@lbl.gov.
>>>
>> --
>> You received this message because you are subscribed to the Google Group=
s
>> "singularity" group.
>> To unsubscribe from this group and stop receiving emails from it, send a=
n
>> email to singu...@lbl.gov.
>>
> --
> You received this message because you are subscribed to the Google Groups
> "singularity" group.
> To unsubscribe from this group and stop receiving emails from it, send an
> email to singu...@lbl.gov.
>

--0000000000003ccec6057ffa57e7
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr"><div dir=3D"ltr">Hi all,<br><br><br>I found that relying o=
n the .julia folder (even if using an alternate=C2=A0JULIA_PKGDIR) was at o=
dds with what containerisation stands for. And it meant I had to think of a=
 new path for JULIA_PKGDIR so as not to interfere with the packaging system=
 of my host&#39;s Julia install.<br><br>I would still like a way to have al=
l of the stuff that would be in the JULIA_PKGDIR to be built within an imag=
e for reproduce-ability... but my workaround was to get the script to creat=
e a tar archive of everything at build time, and upon setting a pre-defined=
 environment variable, give the ability to reset things to how they were at=
 build time.<br><br><br>Here is an example def and scripts to accompany.<br=
><br><br><br><br><pre style=3D"background-color:rgb(32,32,32);color:rgb(205=
,208,212);font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt">projec=
t.def<br></pre><pre style=3D"background-color:rgb(32,32,32);color:rgb(205,2=
08,212);font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt">Bootstra=
p: docker<br>From: julia:0.6.4<br><br>%setup
    # Optional, move a copy of the repo I am interested in, into the contai=
ner (makes things portable for my users who are not modifying code)
    su - $(logname) -c &quot;git clone ${PROJECT_REPO_URL} -b ${PROJECT_REP=
O_BRANCH} ${PROJECT_REPO_LOCATION}&quot; # I do this because git is setup a=
s my user, not root
    chown -R root:root ${PROJECT_REPO_LOCATION}
    chmod -R 0755 ${PROJECT_REPO_LOCATION}
    mv ${PROJECT_REPO_LOC} ${SINGULARITY_ROOTFS}/${PROJECT_REPO_NAME}<br><b=
r>%post
    # Install build tools as others have suggested<br>    apt-get update; a=
pt-get -y install build-essential bzip2 libexpat1-dev<br><br>%environment
    # See environment.sh script below<br>    . /${PROJECT_REPO_NAME}/singul=
arity/environment.sh  # Need to use the literal path here (I have this scri=
pt as part of the repo which as described in %setup, is
                                                        # copied into the c=
ontainer)<br><br>%runscript<br>    exec ${PROJECT_REPO_NAME}/singularity/ru=
nscript.sh &quot;$@&quot;  # Can use a variable defined in %environment her=
e<br></pre><pre style=3D"background-color:rgb(32,32,32);color:rgb(205,208,2=
12);font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt"><pre style=
=3D"font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt">environment.=
sh</pre></pre><pre style=3D"background-color:rgb(32,32,32);color:rgb(205,20=
8,212);font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt"><pre styl=
e=3D"font-family:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt"><span style=
=3D"font-weight:bold">#!/bin/sh<br></span><span style=3D"font-weight:bold">=
<br></span><span style=3D"color:rgb(81,81,81)"># Singularity uses #!/bin/sh=
 for %environment section, so when sourcing these<br></span><span style=3D"=
color:rgb(81,81,81)"># environment variables, be aware of syntax<br></span>=
<span style=3D"color:rgb(81,81,81)"># Also note that environment script is =
baked into the image, so a rebuild is<br></span><span style=3D"color:rgb(81=
,81,81)"># required after each change<br></span><span style=3D"color:rgb(81=
,81,81)"><br></span><span style=3D"color:rgb(11,12,149)">: </span><span sty=
le=3D"color:rgb(204,120,50);font-weight:bold">$</span>{<span style=3D"color=
:rgb(169,183,198)">PROJECT_RESET</span>:=3D0}<br><span style=3D"color:rgb(1=
1,12,149)">export </span>PROJECT_RESET<span style=3D"color:rgb(11,12,149)">=
<br></span><span style=3D"color:rgb(11,12,149)">export </span><span style=
=3D"color:rgb(169,183,198)">PROJECT_CONFIG_DIR</span>=3D<span style=3D"colo=
r:rgb(204,120,50);font-weight:bold">$</span>{<span style=3D"color:rgb(169,1=
83,198)">HOME</span>}/.project/config<br>mkdir -p <span style=3D"color:rgb(=
204,120,50);font-weight:bold">$</span>{PROJECT_CONFIG_DIR}<br><br><span sty=
le=3D"color:rgb(204,120,50);font-weight:bold">if [ </span>! <span style=3D"=
color:rgb(204,120,50);font-weight:bold">-f $</span>{PROJECT_CONFIG_DIR}/.fi=
rstrun<span style=3D"font-size:10.5pt;color:rgb(204,120,50);font-weight:bol=
d"> ]</span><span style=3D"font-size:10.5pt">; </span><span style=3D"font-s=
ize:10.5pt;color:rgb(204,120,50);font-weight:bold">then</span><br><span sty=
le=3D"color:rgb(204,120,50);font-weight:bold">    </span><span style=3D"col=
or:rgb(169,183,198)">PROJECT_HOMEDIR_DEFAULT</span>=3D<span style=3D"color:=
rgb(106,135,89)">&quot;</span><span style=3D"color:rgb(106,135,89);font-wei=
ght:bold">$</span><span style=3D"color:rgb(106,135,89)">{HOME}/.project&quo=
t;<br></span><span style=3D"color:rgb(106,135,89)">    </span><span style=
=3D"color:rgb(11,12,149)">read </span>-p <span style=3D"color:rgb(106,135,8=
9)">&quot;Please enter PROJECT_HOMEDIR [</span><span style=3D"color:rgb(106=
,135,89);font-weight:bold">$</span><span style=3D"color:rgb(106,135,89)">{P=
ROJECT_HOMEDIR_DEFAULT}]: &quot; </span>PROJECT_HOMEDIR<span style=3D"color=
:rgb(106,135,89)"><br></span><span style=3D"color:rgb(169,183,198)">    </s=
pan>PROJECT_HOMEDIR=3D<span style=3D"font-size:10.5pt;color:rgb(106,135,89)=
">&quot;</span><span style=3D"font-size:10.5pt;color:rgb(106,135,89);font-w=
eight:bold">$</span><span style=3D"font-size:10.5pt;color:rgb(106,135,89)">=
{PROJECT_HOMEDIR:-$PROJECT_HOMEDIR_DEFAULT}&quot;</span><br><span style=3D"=
color:rgb(106,135,89)"><br></span><span style=3D"color:rgb(106,135,89)">   =
 </span><span style=3D"color:rgb(11,12,149)">export </span>PROJECT_HOMEDIR;=
 <span style=3D"font-size:10.5pt;color:rgb(11,12,149)">echo </span><span st=
yle=3D"font-size:10.5pt;color:rgb(204,120,50);font-weight:bold">$</span><sp=
an style=3D"font-size:10.5pt">{</span>PROJECT_HOMEDIR} <span style=3D"font-=
size:10.5pt;color:rgb(90,90,90);font-style:italic">&gt; ${</span>PROJECT_CO=
NFIG_DIR}/.home  # From now on PROJECT_HOMEDIR is read from this file<br><s=
pan style=3D"color:rgb(90,90,90);font-style:italic">    </span>touch <span =
style=3D"color:rgb(204,120,50);font-weight:bold">$</span>{PROJECT_CONFIG_DI=
R}/.firstrun  # This ensures that this block of code is only run the first =
time<br><span style=3D"color:rgb(204,120,50);font-weight:bold">else<br></sp=
an><span style=3D"color:rgb(204,120,50);font-weight:bold">    </span><span =
style=3D"color:rgb(11,12,149)">export </span><span style=3D"color:rgb(169,1=
83,198)">PROJECT_HOMEDIR</span>=3D<span style=3D"color:rgb(204,120,50);font=
-weight:bold">$</span>(cat <span style=3D"color:rgb(204,120,50);font-weight=
:bold">$</span>{<span style=3D"color:rgb(169,183,198)">PROJECT_CONFIG_DIR</=
span>}/.home)<br><span style=3D"color:rgb(204,120,50);font-weight:bold">fi<=
br></span><span style=3D"color:rgb(204,120,50);font-weight:bold"><br></span=
><span style=3D"color:rgb(11,12,149)">export </span><span style=3D"color:rg=
b(169,183,198)">PROJECT_PKGDIR</span>=3D<span style=3D"color:rgb(204,120,50=
);font-weight:bold">$</span>{PROJECT_HOMEDIR}/pkg<br><span style=3D"color:r=
gb(11,12,149)">export </span><span style=3D"color:rgb(169,183,198)">PROJECT=
_TARPATH</span>=3D<span style=3D"color:rgb(204,120,50);font-weight:bold">$<=
/span>{PROJECT_HOMEDIR}/pkg.tar.gz<br><span style=3D"color:rgb(11,12,149)">=
export </span><span style=3D"color:rgb(169,183,198)">JULIA_PKGDIR</span>=3D=
<span style=3D"color:rgb(204,120,50);font-weight:bold">$</span>{PROJECT_PKG=
DIR<span style=3D"font-size:10.5pt">}/.julia</span></pre></pre></div><div><=
pre style=3D"background-color:rgb(32,32,32);color:rgb(205,208,212);font-fam=
ily:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt"><pre style=3D"font-famil=
y:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt">runscript.sh</pre></pre><p=
re style=3D"background-color:rgb(32,32,32);font-family:&quot;DejaVu Sans Mo=
no&quot;;font-size:10.5pt"><pre style=3D"color:rgb(205,208,212);font-family=
:&quot;DejaVu Sans Mono&quot;;font-size:10.5pt"><span style=3D"font-weight:=
bold">#!/bin/bash -eu<br></span><span style=3D"font-weight:bold"><br></span=
><span style=3D"color:rgb(204,120,50);font-weight:bold">if [[ $</span>{<spa=
n style=3D"color:rgb(169,183,198)">PROJECT_RESET</span>} <span style=3D"col=
or:rgb(204,120,50);font-weight:bold">-eq </span>1<span style=3D"color:rgb(2=
04,120,50);font-weight:bold"> ]]</span>; <span style=3D"color:rgb(204,120,5=
0);font-weight:bold">then<br></span><span style=3D"color:rgb(204,120,50);fo=
nt-weight:bold">    </span>rm -rf <span style=3D"color:rgb(204,120,50);font=
-weight:bold">$</span>{PROJECT_PKGDIR<span style=3D"font-size:10.5pt">}</sp=
an><br>    mkdir -p <span style=3D"color:rgb(204,120,50);font-weight:bold">=
$</span>{PROJECT_PKGDIR<span style=3D"font-size:10.5pt">}</span><br>    tar=
 -xzf <span style=3D"color:rgb(204,120,50);font-weight:bold">$</span>{PROJE=
CT_TARPATH<span style=3D"font-size:10.5pt">} -C </span><span style=3D"font-=
size:10.5pt;color:rgb(204,120,50);font-weight:bold">$</span><span style=3D"=
font-size:10.5pt">{</span>PROJECT_PKGDIR<span style=3D"font-size:10.5pt">}<=
/span><br><span style=3D"color:rgb(204,120,50);font-weight:bold">else<br></=
span><span style=3D"color:rgb(204,120,50);font-weight:bold">    if [[ </spa=
n>! <span style=3D"color:rgb(204,120,50);font-weight:bold">-d $</span>{PROJ=
ECT_PKGDIR<span style=3D"font-size:10.5pt">}</span><span style=3D"font-size=
:10.5pt;color:rgb(204,120,50);font-weight:bold"> ]]</span><span style=3D"fo=
nt-size:10.5pt">; </span><span style=3D"font-size:10.5pt;color:rgb(204,120,=
50);font-weight:bold">then</span></pre><pre style=3D"font-family:&quot;Deja=
Vu Sans Mono&quot;;font-size:10.5pt"><pre style=3D"font-size:10.5pt;font-fa=
mily:&quot;DejaVu Sans Mono&quot;"><font color=3D"#cdd0d4">        # This i=
s where, on first run all of the Julia package building takes place. Note, =
you cannot move the artifacts and these artifacts
        # will be owned by the user running the container. Sub in your own =
Julia packages here.</font><br></pre><font color=3D"#cdd0d4" style=3D"font-=
size:10.5pt">        julia -e </font><span style=3D"font-size:10.5pt;color:=
rgb(106,135,89)">&#39; \</span><span style=3D"color:rgb(106,135,89)">      =
     =20
            Pkg.init(); Pkg.update(); \<br></span><span style=3D"color:rgb(=
106,135,89)">            Pkg.clone(&quot;<a href=3D"https://github.com/HIVD=
iversity/NextGenSeqUtils.jl">https://github.com/HIVDiversity/NextGenSeqUtil=
s.jl</a>&quot;); \<br></span><span style=3D"color:rgb(106,135,89)">        =
    Pkg.checkout(&quot;NextGenSeqUtils&quot;, &quot;dev&quot;); \<br></span=
><span style=3D"color:rgb(106,135,89)">            using NextGenSeqUtils; \=
<br></span><span style=3D"color:rgb(106,135,89)">        &#39;<br></span><s=
pan style=3D"color:rgb(106,135,89)">        </span><span style=3D"color:rgb=
(11,12,149)">cd </span><span style=3D"color:rgb(204,120,50);font-weight:bol=
d">$</span><font color=3D"#cdd0d4">{</font><span style=3D"color:rgb(169,183=
,198)">PROJECT_PKGDIR</span><font color=3D"#cdd0d4">}</font><font color=3D"=
#cdd0d4"><br>        rm -f </font><span style=3D"color:rgb(204,120,50);font=
-weight:bold">$</span><font color=3D"#cdd0d4">{</font><span style=3D"color:=
rgb(169,183,198)">PROJECT_TARPATH</span><font color=3D"#cdd0d4">}<br>      =
  </font><span style=3D"color:rgb(11,12,149)">export </span><span style=3D"=
color:rgb(169,183,198)">GZIP</span><font color=3D"#cdd0d4">=3D-9; tar -czf =
</font><span style=3D"color:rgb(204,120,50);font-weight:bold">$</span><font=
 color=3D"#cdd0d4">{PROJECT</font><span style=3D"color:rgb(169,183,198)">_T=
ARPATH</span><font color=3D"#cdd0d4">} .<br>    </font><span style=3D"color=
:rgb(204,120,50);font-weight:bold">fi<br></span><span style=3D"color:rgb(20=
4,120,50);font-weight:bold">fi<br></span><span style=3D"color:rgb(11,12,149=
)">exec </span><span style=3D"color:rgb(204,120,50);font-weight:bold">$</sp=
an><font color=3D"#cdd0d4">{PROJECT</font><span style=3D"color:rgb(169,183,=
198)">_REPODIR</span><font color=3D"#cdd0d4">}/src/somescript.sh </font><sp=
an style=3D"color:rgb(106,135,89)">&quot;$@&quot;<br></span></pre></pre></d=
iv><br>Don&#39;t know if this helps or not.<br><br>I wish that I was able t=
o ship what is currently locked in the tar, in the image itself. That way, =
no matter which user you are... you have a copy of everything required to g=
o. Because with the above, in a multi-user linux system, each user has to d=
o the above and each user has a seperate copy of the same Julia packages (t=
hat could be slightly different given the date they complete the first run)=
.<br><br>Containerisation is supposed to avoid this kind of source for irre=
producability.<br><br><br>What are your thoughts? Is there a mechanism by w=
hich I can do the above in a more satisfactory way?<br><br><br><br><br>Kind=
 regards,<br>Dean<br><br><br><br><br><br><div class=3D"gmail_quote"><div di=
r=3D"ltr" class=3D"gmail_attr">On Mon, Jan 21, 2019 at 4:54 PM &#39;John He=
arns&#39; via singularity &lt;<a href=3D"mailto:singu...@lbl.gov">singu...@=
lbl.gov</a>&gt; wrote:<br></div><blockquote class=3D"gmail_quote" style=3D"=
margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-lef=
t:1ex"><div dir=3D"ltr"><div>Tim, thankyou for the update.</div><div>This i=
s not the place for me to comment on Julia, however I will and apologise to=
 anyone getting bored with this.</div><div>0.6 was supposed to be followed =
by 0.7 which had deprecation warnings. Package owners were supposed to test=
 with 0.7</div><div>Then 1.0 should have been introduced.</div><div>As you =
have seen significant packages are still to catch up.</div><div>We are prom=
ised failtfully that there will be no breaking cahnges in the 1.x series so=
 here is hoping that things settle down.</div><div><br></div><div><br></div=
><div><br></div></div><br><div class=3D"gmail_quote"><div class=3D"gmail-m_=
117908650454839163gmail_attr" dir=3D"ltr">On Sat, 19 Jan 2019 at 16:47, Tim=
s Corbett &lt;<a href=3D"mailto:tims....@gmail.com" target=3D"_blank">tims.=
...@gmail.com</a>&gt; wrote:<br></div><blockquote class=3D"gmail_quote" sty=
le=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left:1px solid rgb(2=
04,204,204)"><div dir=3D"ltr"><div dir=3D"ltr">Thanks John. It strikes a ba=
lance and serves my purpose.<div><br></div><div>I have to provide both 0.6.=
4 and 0.1.=C2=A0</div><div>Knitro package has some compatibility issues wit=
h Julia 1.0.</div><div><div><br></div><div>So here are the steps:</div><div=
><br></div><div>1. build a plain singularity image with julia base. set the=
 JULIA_PKGDIR (pointing to host to bind later) in %environment=C2=A0</div><=
div>2. run the following to install new packages and force precompile on th=
em</div><div><br></div><div>julia --version</div><div>julia -e &#39;Pkg.res=
olve()&#39;</div><div>sudo cat /.julia/v0.6/REQUIRE | xargs --verbose -I &#=
39;{}&#39; bash -c &quot;julia -e &#39;using {}&#39;&quot;</div></div><div>=
<br></div><div>3. create containers as needed</div><div><br></div><div><div=
>singularity exec -B /.julia/ ./intelmpi-julia0.6.4.simg julia -e &quot;usi=
ng Complementarity&quot;</div><div>singularity exec -B /.julia/ ./intelmpi-=
julia0.6.4.simg julia -e &quot;using Ipopt&quot;</div><br class=3D"gmail-m_=
117908650454839163gmail-m_7277801922873538751gmail-Apple-interchange-newlin=
e"></div><div>The catch is that bind inside and outside paths must be exact=
ly the=C2=A0same (no aliases).</div><div><br></div><div>Thanks again!</div>=
<div><br></div></div></div><br><div class=3D"gmail_quote"><div class=3D"gma=
il-m_117908650454839163gmail-m_7277801922873538751gmail_attr" dir=3D"ltr">O=
n Sat, Jan 19, 2019 at 2:11 AM &#39;John Hearns&#39; via singularity &lt;<a=
 href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.gov</a>&gt=
; wrote:<br></div><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px=
 0px 0.8ex;padding-left:1ex;border-left:1px solid rgb(204,204,204)"><div di=
r=3D"ltr"><div dir=3D"ltr">Tim,=C2=A0 I think you need to put in a mount fo=
r your home directory.<div>Also with Julia if you add packages as the root =
user these are personal to the root user.</div><div>Packages live under .ju=
lia in your account - but this is just the default.</div><div>You can have =
system wide Julia packages, but you then have to set JULIA_HOME=C2=A0</div>=
<div>See=C2=A0<a href=3D"https://docs.julialang.org/en/v0.6.0/manual/enviro=
nment-variables/" target=3D"_blank">https://docs.julialang.org/en/v0.6.0/ma=
nual/environment-variables/</a></div><div><br></div><div>If you use the Mod=
ules system you can have a Module set these - and also have different versi=
ons of Julia on your system.</div><div><br></div><div>Also, above, I was ta=
lking about running the same version of Julia on a system wide command line=
 and installing packages,</div><div>which are then &#39;picked up&#39; when=
 the container is run and mounts your home dir.</div><div>Before anyone say=
s it, this defeats the purpose of containers.</div><div>However Julia can m=
ix 0.6 and 1.0 ec. versions in your .julia=C2=A0</div><div><br></div><div><=
br></div><div><br></div><div><br></div><div><br></div></div></div><br><div =
class=3D"gmail_quote"><div class=3D"gmail-m_117908650454839163gmail-m_72778=
01922873538751gmail-m_-7407702778185183091gmail_attr" dir=3D"ltr">On Sat, 1=
9 Jan 2019 at 06:20, Tims Corbett &lt;<a href=3D"mailto:tims....@gmail.com"=
 target=3D"_blank">tims....@gmail.com</a>&gt; wrote:<br></div><blockquote c=
lass=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;bor=
der-left:1px solid rgb(204,204,204)"><div dir=3D"ltr"><div dir=3D"ltr">Here=
&#39;s the recipe, good night<div><br></div><div><div>Bootstrap: docker</di=
v><div>From: julia:0.6.4</div><div><br></div><div><br></div><div>%post</div=
><div><span style=3D"white-space:pre-wrap">=09</span>apt-get update</div><d=
iv><span style=3D"white-space:pre-wrap">=09</span>apt-get install -y build-=
essential</div><div><span style=3D"white-space:pre-wrap">=09</span>apt-get =
install -y wget</div><div><span style=3D"white-space:pre-wrap">=09</span>ap=
t-get install -y gfortran</div><div><span style=3D"white-space:pre-wrap">=
=09</span>apt-get install -y hdf5-tools</div><div><br></div><div><span styl=
e=3D"white-space:pre-wrap">=09</span>export JULIA_PKGDIR=3D/root/.julia/</d=
iv><div><br></div><div><span style=3D"white-space:pre-wrap">=09</span>julia=
 -e &#39;Pkg.init(); Pkg.update(); Pkg.add.([&quot;CSV&quot;,&quot;GLPK&quo=
t;,&quot;DataStreams&quot;,&quot;FunctionWrappers&quot;,&quot;KNITRO&quot;,=
&quot;ConditionalJuMP&quot;,&quot;Missings&quot;,&quot;Ipopt&quot;,&quot;MA=
T&quot;,&quot;DataArrays&quot;,&quot;GLPKMathProgInterface&quot;,&quot;Data=
Frames&quot;,&quot;PATHSolver&quot;, &quot;Complementarity&quot;]); Pkg.bui=
ld()&#39;</div><div><br></div><div><span style=3D"white-space:pre-wrap">=09=
</span>sed -i &#39;1270 s/^/#/&#39; /root/.julia/v0.6/JuMP/src/nlp.jl</div>=
<div><span style=3D"white-space:pre-wrap">=09</span>sed -i &#39;1280 s/^/#/=
&#39; /root/.julia/v0.6/JuMP/src/nlp.jl</div><div><br></div><div><span styl=
e=3D"white-space:pre-wrap">=09</span>julia --version<span style=3D"white-sp=
ace:pre-wrap">=09</span></div><div><br></div><div>%environment</div><div><s=
pan style=3D"white-space:pre-wrap">=09</span>SHELL=3D/bin/bash</div><div><b=
r></div><div><span style=3D"white-space:pre-wrap">=09</span>PATH=3D/usr/loc=
al/julia/bin/julia:$PATH<span style=3D"white-space:pre-wrap">=09</span></di=
v><div><span style=3D"white-space:pre-wrap">=09</span>LD_LIBRARY_PATH=3D/us=
r/local/julia/lib/julia:$LD_LIBRARY_PATH</div><div><br></div><div><span sty=
le=3D"white-space:pre-wrap">=09</span>export JULIA_PKGDIR=3D/root/.julia/</=
div><div><br></div><div>############### INSTRUCTIONS TO RUN ###############=
</div><div>#</div><div># sudo singularity build --sandbox intelmpi-julia0.6=
.4.img intelmpi-julia0.6.4.recipe</div><div># sudo singularity build intelm=
pi-julia0.6.4.simg intelmpi-julia0.6.4.img/</div></div><div><br></div></div=
></div><br><div class=3D"gmail_quote"><div class=3D"gmail-m_117908650454839=
163gmail-m_7277801922873538751gmail-m_-7407702778185183091gmail-m_-40515760=
4992555184gmail_attr" dir=3D"ltr">On Fri, Jan 18, 2019 at 10:05 PM &#39;Joh=
n Hearns&#39; via singularity &lt;<a href=3D"mailto:singu...@lbl.gov" targe=
t=3D"_blank">singu...@lbl.gov</a>&gt; wrote:<br></div><blockquote class=3D"=
gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left=
:1px solid rgb(204,204,204)"><div dir=3D"ltr">Tim, I have to get some sleep=
.<div>Could you give us the definition file for your container?</div><div>I=
 am being lazy and pulling the latest Julia container from Docker hub.</div=
></div><br><div class=3D"gmail_quote"><div class=3D"gmail-m_117908650454839=
163gmail-m_7277801922873538751gmail-m_-7407702778185183091gmail-m_-40515760=
4992555184gmail-m_-3608874818835691305gmail_attr" dir=3D"ltr">On Sat, 19 Ja=
n 2019 at 05:51, Tims &lt;<a href=3D"mailto:tims....@gmail.com" target=3D"_=
blank">tims....@gmail.com</a>&gt; wrote:<br></div><blockquote class=3D"gmai=
l_quote" style=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left:1px=
 solid rgb(204,204,204)"><div dir=3D"ltr"><div>per your suggestion John, I =
am trying to install Ipopt from REPL.</div><div>So, first trying to remove =
Ipopt:</div><div><br></div><div>=C2=A0Pkg.rm(&quot;Ipopt&quot;)</div><div>I=
NFO: Removing Ipopt v0.4.5</div><div>ERROR: sendfile: no space left on devi=
ce (ENOSPC)</div><div><br></div><div>Started REPL as:</div><div>singularity=
 shell intelmpi-julia0.6.4.img/<br></div><div>julia</div><div><br></div><di=
v><br></div><br>On Friday, January 18, 2019 at 9:38:03 PM UTC-8, John Hearn=
s wrote:<blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex=
;padding-left:1ex;border-left:1px solid rgb(204,204,204)"><div dir=3D"ltr">=
<div dir=3D"ltr">Having said what I just said, running Julia 1.0.3 within t=
he container I had to do Pkg.build(&quot;SpecialFunctions&quot;)</div><div>=
Working OK now though=C2=A0 - curioser and curioser as Alice said.</div></d=
iv><br><div class=3D"gmail_quote"><div dir=3D"ltr">On Sat, 19 Jan 2019 at 0=
5:31, John Hearns &lt;<a rel=3D"nofollow">h...@googlemail.com</a>&gt; wrote=
:<br></div><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.=
8ex;padding-left:1ex;border-left:1px solid rgb(204,204,204)"><div dir=3D"lt=
r"><div dir=3D"ltr">Also shirking responsibility here - the folks over at=
=C2=A0<a href=3D"https://discourse.julialang.org/" rel=3D"nofollow" target=
=3D"_blank">https://discourse.julialang.org/</a> are pretty helpful.</div><=
div>I think you have pointed out a wrinkle regarding usign Julia in contain=
ers - you need to either bring along a development environment, or install =
things beforehand in your .julia</div></div><br><div class=3D"gmail_quote">=
<div dir=3D"ltr">On Sat, 19 Jan 2019 at 05:28, John Hearns &lt;<a rel=3D"no=
follow">h...@googlemail.com</a>&gt; wrote:<br></div><blockquote class=3D"gm=
ail_quote" style=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left:1=
px solid rgb(204,204,204)"><div dir=3D"ltr">Going out on a bit of a limb he=
re I think they way forward it to<div><br></div><div>a) create a container =
with all the build tools which are needed</div><div><br></div><div>b) run t=
he Julia REPL from a normal shell, Pkg add and Pkg build all the packages y=
ou need</div><div>Then when the container runs it should pick up everything=
 from your .julia directory</div><div>I may be wrong</div></div><br><div cl=
ass=3D"gmail_quote"><div dir=3D"ltr">On Sat, 19 Jan 2019 at 05:25, John Hea=
rns &lt;<a rel=3D"nofollow">h...@googlemail.com</a>&gt; wrote:<br></div><bl=
ockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;padding-le=
ft:1ex;border-left:1px solid rgb(204,204,204)"><div dir=3D"ltr"><div dir=3D=
"ltr">Hi Tim.=C2=A0=C2=A0<div>Why are you running as root? Is that necessar=
y?</div><div><br></div><div>When I try to add the Complementarity module in=
 the version 1.0.3 container</div><div><div><br></div><div>=E2=94=82 [ Info=
: Changing directory to /home/hearnsj/.julia/packages/PATHSolver/xjazJ/deps=
/src/PathJulia-0.1.2/src</div><div>=E2=94=82 ERROR: LoadError: IOError: cou=
ld not spawn `make linux64`: no such file or directory (ENOENT)</div><div>=
=E2=94=82 Stacktrace:</div></div><div><br></div><div>I guess all that is sa=
ying is that &#39;make&#39; is not installed int he container.</div><div><b=
r></div><div><br></div><div>I guess you dont have command line Julia 0.6.4 =
installed on your system.</div><div>Maybe worth installing that, and trying=
 to add Complementarity</div><div>I thought I had 0.6 as an alternative on =
my system,=C2=A0 but sorry seem to have deleted it</div><div><br></div><div=
><br></div><div><br></div></div></div><br><div class=3D"gmail_quote"><div d=
ir=3D"ltr">On Sat, 19 Jan 2019 at 04:50, Tims &lt;<a rel=3D"nofollow">ti...=
@gmail.com</a>&gt; wrote:<br></div><blockquote class=3D"gmail_quote" style=
=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left:1px solid rgb(204=
,204,204)"><div dir=3D"ltr"><div>Thanks John, yes I need 0.6.4.</div>The wo=
rkaround I have is to chown and give wheel access to /root/.julia and then =
convert from sandbox to squashfs.<div>It=C2=A0 works for package Compat.but=
 breaks witha seg fault for package Complementarity.</div><div><br></div><d=
iv><div>singularity exec intelmpi-julia0.6.4.img/ julia -e &quot;using Comp=
lementarity&quot;</div><div><br></div><div>signal (11): Segmentation fault<=
/div><div>while loading /root/.julia/v0.6/ForwardDiff/src/ForwardDiff.jl, i=
n expression starting on line 12</div></div><div><br></div><div>Any clue?</=
div><div><br><br><br>On Friday, January 18, 2019 at 8:30:22 PM UTC-8, John =
Hearns wrote:<blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px =
0.8ex;padding-left:1ex;border-left:1px solid rgb(204,204,204)"><div dir=3D"=
ltr">Hi Tim.=C2=A0 I guess you have good reasons for using Julia version 0.=
6.4 - most probably because you have code which only runs with this version=
, and hence why Compay.jl is being asked for also.<div><br></div><div>Not v=
ery helpful of me, but using Singularity 3.0.2 I can pull a Julia container=
 from the Docker registry which has Julia 1.0.3</div><div><br></div><div>si=
ngularity pull docker://julia</div><div>singularity exec julia_latest.sif=
=C2=A0 julia -e &#39;import Pkg; Pkg.add(&quot;Compat&quot;); using Compat&=
#39;<br></div><div><br></div><div>The .julia directory from my own account =
is being used - I can add packages before execing the container also.</div>=
<div>The extra Pkg stuff after -e is due to the new Julia package manager, =
if anyone is wondering why. You have to pull Pkg in now as it is not in Bas=
e AFAIK</div><div><br></div><div><br></div></div><br><div class=3D"gmail_qu=
ote"><div dir=3D"ltr">On Sat, 19 Jan 2019 at 02:21, Tims &lt;<a rel=3D"nofo=
llow">ti...@gmail.com</a>&gt; wrote:<br></div><blockquote class=3D"gmail_qu=
ote" style=3D"margin:0px 0px 0px 0.8ex;padding-left:1ex;border-left:1px sol=
id rgb(204,204,204)"><div dir=3D"ltr">The image was built from a sandbox as=
<div><br></div><div><div>sudo singularity build julia0.6.4.simg julia0.6.4.=
img/</div><div><br></div><div><br></div><div><div>singularity exec intelmpi=
-julia0.6.4.simg julia -e &#39;using Compat&#39;</div><div><br></div><div>E=
RROR: SystemError: opening file /root/.julia/lib/v0.6/Compat.ji: Permission=
 denied</div><div>Stacktrace:</div></div><div><br></div><div><br></div><div=
><br></div><br>On Friday, January 18, 2019 at 2:19:33 PM UTC-8, Tims wrote:=
<blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;padding=
-left:1ex;border-left:1px solid rgb(204,204,204)"><div dir=3D"ltr"><br><div=
>While running a singularity container, Julia is apparently trying to preco=
mpile packages and running into permission errors.</div><div><br></div><div=
><div>ERROR: LoadError: LoadError: SystemError: opening file /root/.julia/l=
ib/v0.6/Compat.ji: Permission denied</div></div><div><br></div><div><br></d=
iv><div>What is a good way to avoid this error without sudo ing?</div></div=
></blockquote></div></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a rel=3D"nofollow">singu...@lbl.gov</a>.<br>
</blockquote></div>
</blockquote></div></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a rel=3D"nofollow">singu...@lbl.gov</a>.<br>
</blockquote></div>
</blockquote></div>
</blockquote></div>
</blockquote></div>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.=
gov</a>.<br>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to a topic in the Goog=
le Groups &quot;singularity&quot; group.<br>
To unsubscribe from this topic, visit <a href=3D"https://groups.google.com/=
a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/unsubscribe" target=3D"_blank">ht=
tps://groups.google.com/a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/unsubscri=
be</a>.<br>
To unsubscribe from this group and all its topics, send an email to <a href=
=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.gov</a>.<br>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.=
gov</a>.<br>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to a topic in the Goog=
le Groups &quot;singularity&quot; group.<br>
To unsubscribe from this topic, visit <a href=3D"https://groups.google.com/=
a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/unsubscribe" target=3D"_blank">ht=
tps://groups.google.com/a/lbl.gov/d/topic/singularity/Vv5ccqWjO6E/unsubscri=
be</a>.<br>
To unsubscribe from this group and all its topics, send an email to <a href=
=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.gov</a>.<br>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.=
gov</a>.<br>
</blockquote></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singu...@lbl.=
gov</a>.<br>
</blockquote></div></div>

--0000000000003ccec6057ffa57e7--
