X-Received: by 10.200.49.186 with SMTP id h55mr1277119qte.79.1499808345719;
        Tue, 11 Jul 2017 14:25:45 -0700 (PDT)
X-BeenThere: singularity@lbl.gov
Received: by 10.36.82.3 with SMTP id d3ls230746itb.13.gmail; Tue, 11 Jul 2017
 14:25:45 -0700 (PDT)
X-Received: by 10.84.130.76 with SMTP id 70mr466626plc.138.1499808344807;
        Tue, 11 Jul 2017 14:25:44 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; t=1499808344; cv=none;
        d=google.com; s=arc-20160816;
        b=ZXJHAtuwdkR77DKLRnl4xZVjuLs7+8ttSYC87UvYgW0z3ehyHPqvRWWtKLL59s3fzW
         0m+QERFc3UWtPzZfyUUIrqb4O9rBqoT4EduNb0f8RyrR5G46Dz+SAXLpdmd12oq69EAe
         GO5tYVj6FpapoCAr4DbmO9BeQWDYlWAwM2VYXP1MEm6wkjBoj5J7pray2QAn/A8wS7wi
         THERjtad7X5o/v6uIKsNn12ajNBDCfaD0gHK7GkDLAjMjsbBy9SZ+VqskO6jzyL55art
         v03kvBHVPqPFlK2+6OSPomZJV+3ZO6FtZI0q2T1RPKwO1tt/ief5XlfProfXWifdZc8Q
         tO+Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=mime-version:content-language:accept-language:in-reply-to
         :references:message-id:date:thread-index:thread-topic:subject:to
         :from:arc-authentication-results;
        bh=+Ylluwi1OPxLierp4KBhw66Gkgbrgjr2u+eI5auQXJw=;
        b=tUos153offywJ8q1/JJXm2MWdHp1gxwM/L5Vefx/KOUyyMevoqmBYm1EUSs0bcFPjJ
         uYCcRq4thHojJUEKRYty6e7LWFGazgUnBRlX1MQQbRfErfwkhsI9FZ3ADSk8HC0BU/QL
         raFvoBF9/inB4kYTIzorcJo0vQ5JbUFjFeWx1ElcrfKeziOp0jqp/OVvrUImgzSZmprP
         CU6AYxmBMJ8xu9bBPAzGu+ZWGWkwxbvd3/cazZT70pOuc68F+qWUTg0wuoGKJkgnOXx2
         N83aPPZNaRZRDIpWPsmBUmm9WdUqC4dpJNbjShAc1xuxp1xNxI+7iqhwH9yTU8Vz5iNJ
         zRRQ==
ARC-Authentication-Results: i=1; mx.google.com;
       spf=pass (google.com: domain of mka...@sdsc.edu designates 132.239.0.7 as permitted sender) smtp.mailfrom=mka...@sdsc.edu
Return-Path: <mka...@sdsc.edu>
Received: from fe4.lbl.gov (fe4.lbl.gov. [128.3.41.71])
        by mx.google.com with ESMTP id p7si291757pll.609.2017.07.11.14.25.44
        for <singu...@lbl.gov>;
        Tue, 11 Jul 2017 14:25:44 -0700 (PDT)
Received-SPF: pass (google.com: domain of mka...@sdsc.edu designates 132.239.0.7 as permitted sender) client-ip=132.239.0.7;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of mka...@sdsc.edu designates 132.239.0.7 as permitted sender) smtp.mailfrom=mka...@sdsc.edu
X-Ironport-SBRS: 3.5
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0FOAQBeQWVZhwcA74RaAxwBAQQBAQoBA?=
 =?us-ascii?q?RcBAQQBAQoBAYJEIh6BD4EUB4NhixSQfIgujG9mgU4bHQgDASABCoVKAoM+QRY?=
 =?us-ascii?q?BAQEBAQEBAQEBAQIQAQEBCgsJCCgkC4IzBQIDGgYIRiYDAywBAQEBAQEBAQEBA?=
 =?us-ascii?q?QEBAQEaAggFOAsBARgBAQEBAxo0HxwCAQgRBAEBCxYHByEQARQJCAIECAcEAQc?=
 =?us-ascii?q?VBIg8bkwDFQEEC6o2EYNJhzANRAEHgxgBAQEBAQEBAwEBAQEBAQEBAQEBHYMog?=
 =?us-ascii?q?06FBIJXIi+BExIBBhgdAhURgnyCMQWRG4Yghy41BgKHRodWhnpXj0KJO4ITL4l?=
 =?us-ascii?q?KJgVsDTMLdxOFbIFzdgEHhXZHXAGBDAEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0FOAQBeQWVZhwcA74RaAxwBAQQBAQoBARcBAQQBAQoBAYJ?=
 =?us-ascii?q?EIh6BD4EUB4NhixSQfIgujG9mgU4bHQgDASABCoVKAoM+QRYBAQEBAQEBAQEBA?=
 =?us-ascii?q?QIQAQEBCgsJCCgkC4IzBQIDGgYIRiYDAywBAQEBAQEBAQEBAQEBAQEaAggFOAs?=
 =?us-ascii?q?BARgBAQEBAxo0HxwCAQgRBAEBCxYHByEQARQJCAIECAcEAQcVBIg8bkwDFQEEC?=
 =?us-ascii?q?6o2EYNJhzANRAEHgxgBAQEBAQEBAwEBAQEBAQEBAQEBHYMog06FBIJXIi+BExI?=
 =?us-ascii?q?BBhgdAhURgnyCMQWRG4Yghy41BgKHRodWhnpXj0KJO4ITL4lKJgVsDTMLdxOFb?=
 =?us-ascii?q?IFzdgEHhXZHXAGBDAEBAQ?=
X-IronPort-AV: E=Sophos;i="5.40,347,1496127600"; 
   d="scan'208,217";a="81215765"
Received: from iport-acv4-out.ucsd.edu ([132.239.0.7])
  by fe4.lbl.gov with ESMTP; 11 Jul 2017 14:25:42 -0700
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A2EAAgBeQWVZ/8wA74RaAxwBAQQBAQoBA?=
 =?us-ascii?q?RcBAQQBAQoBAYJEIh6BD4EUB4NhixSQfIgujG9mgU4bHQgDASABCoVKAoN/FgE?=
 =?us-ascii?q?BAQEBAQEBAQEBAmgdC4IzBQIDGgYIRiYDAywBAQEBAQEBAQEBAQEBAQEaAggFO?=
 =?us-ascii?q?AsBARgBAQEBAxo0HxwCAQgRBAEBCxYHByEQARQJCAIECAcEAQcVBIg8bkwDFQE?=
 =?us-ascii?q?PqjYRg0mHMA1EAQeDGAEBAQEBAQQBAQEBAQEBAQEBAR2DKINOhQSCVyIvgRMSA?=
 =?us-ascii?q?QYYHQIVEYIPbYIxBZEbhiCHLjUGAodGh1aGelePQok7ghMviUomBS0/DTMLdxO?=
 =?us-ascii?q?HX3YBB4V2R1wBgQwBAQE?=
X-IPAS-Result: =?us-ascii?q?A2EAAgBeQWVZ/8wA74RaAxwBAQQBAQoBARcBAQQBAQoBAYJ?=
 =?us-ascii?q?EIh6BD4EUB4NhixSQfIgujG9mgU4bHQgDASABCoVKAoN/FgEBAQEBAQEBAQEBA?=
 =?us-ascii?q?mgdC4IzBQIDGgYIRiYDAywBAQEBAQEBAQEBAQEBAQEaAggFOAsBARgBAQEBAxo?=
 =?us-ascii?q?0HxwCAQgRBAEBCxYHByEQARQJCAIECAcEAQcVBIg8bkwDFQEPqjYRg0mHMA1EA?=
 =?us-ascii?q?QeDGAEBAQEBAQQBAQEBAQEBAQEBAR2DKINOhQSCVyIvgRMSAQYYHQIVEYIPbYI?=
 =?us-ascii?q?xBZEbhiCHLjUGAodGh1aGelePQok7ghMviUomBS0/DTMLdxOHX3YBB4V2R1wBg?=
 =?us-ascii?q?QwBAQE?=
X-IronPort-AV: E=Sophos;i="5.40,347,1496127600"; 
   d="scan'208,217";a="256101232"
X-Spam-Status: No
X-Spam-Level: 
Received: from xcore-tpcs2.ucsd.edu (HELO XCORE-TPCS2.AD.UCSD.EDU) ([132.239.0.204])
  by iport-acv4-out.ucsd.edu with ESMTP/TLS/AES256-SHA; 11 Jul 2017 14:25:41 -0700
Received: from XMAIL-MBX-BT1.AD.UCSD.EDU ([fe80::b066:a961:2460:32af]) by
 XCORE-TPCS2.AD.UCSD.EDU ([fe80::95f8:1460:c137:278c%11]) with mapi id
 14.03.0319.002; Tue, 11 Jul 2017 14:25:40 -0700
From: "Kandes, Martin" <mka...@sdsc.edu>
To: "singu...@lbl.gov" <singu...@lbl.gov>
Subject: RE: [Singularity] Caffe
Thread-Topic: [Singularity] Caffe
Thread-Index: AQHS+ldvAYPhKbujs0WuUEmo/ndAqqJPXlsAgAAy7oD//4vFkw==
Date: Tue, 11 Jul 2017 21:25:39 +0000
Message-ID: <B58197C146EC324AA00A2A07DC0826027028711E@XMAIL-MBX-BT1.AD.UCSD.EDU>
References: <b5aa92c7-2b2f-4936-bbd3-0961934b1688@lbl.gov>
 <CAM=pu+L=8Q+z3WbGEC5Zw8pEbEzKpuTPGsobOvn2DwaR03R3kg@mail.gmail.com>,<CABMqZXmg--j3+yiyCH3t6AYBjJTWSW8Sr_HAk23gm4cL_WjL4g@mail.gmail.com>
In-Reply-To: <CABMqZXmg--j3+yiyCH3t6AYBjJTWSW8Sr_HAk23gm4cL_WjL4g@mail.gmail.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach:
X-MS-TNEF-Correlator:
x-originating-ip: [169.228.116.46]
Content-Type: multipart/alternative;
	boundary="_000_B58197C146EC324AA00A2A07DC0826027028711EXMAILMBXBT1ADUC_"
MIME-Version: 1.0

--_000_B58197C146EC324AA00A2A07DC0826027028711EXMAILMBXBT1ADUC_
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable

Dimitri,

I'm currently waiting on the ImageNet dataset to download. And it doesn't l=
ook like it's going to complete anytime soon --- they must be throttling th=
e download on their side. Therefore, it might be another day or so before I=
 get back to giving Caffe a good test. However, if you want to give my cont=
ainer a try on your problem, feel free --- here's the definition file [1]. =
It's based on an older version of Nvcaffe already packaged by Nvidia. Note,=
 you'll probably want to change the driver version to match the one deploye=
d on the system you intend to run the container. We're still running an old=
er version of Singularity (v2.2) as well as an older Nvidia driver (v367.48=
), so we haven't had the chance to try the --nv option yet. But probably sa=
fe to make everything match up anyway.

Marty

P.S. I'm basically trying to reproduce Nvidia's own benchmarks: http://www.=
nvidia.com/object/caffe-deep-learning-framework.html

[1]

Bootstrap: debootstrap
MirrorURL: http://us.archive.ubuntu.com/ubuntu
OSVersion: xenial

%labels

    AUTHOR_NAME Marty Kandes
    AUTHOR_EMAIL mka...@sdsc.edu
    OPERATING_SYSTEM_NAME ubuntu
    OPERATING_SYSTEM_VERSION 16.04
    APPLICATION_NAME caffe-nv
    APPLICATION_VERSION 0.15.13
    SYSTEM_NAME comet
    SYSTEM_SINGULARITY_VERSION 2.2
    VERSION 0.0.1

%setup

%environment

%post -c /bin/bash

    declare -r MIRRORURL=3D'http://us.archive.ubuntu.com/ubuntu'
    declare -r OSVERSION=3D'xenial'

    apt-get -y install ubuntu-minimal
    apt-get -y install ubuntu-standard
    apt-get -y install ubuntu-server

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} restricted"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} multiverse"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates restricted=
"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates multiverse=
"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports restrict=
ed"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports universe=
"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports multiver=
se"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security restricte=
d"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security multivers=
e"

    apt-get -y update && apt-get -y upgrade

    mkdir /cvmfs /oasis /projects /scratch

    declare -r NVIDIA_ROOT_URL=3D'http://developer.download.nvidia.com/comp=
ute'
    declare -r CUDA_REPO_URL=3D"${NVIDIA_ROOT_URL}/cuda/repos/ubuntu1604/x8=
6_64"
    declare -r ML_REPO_URL=3D"${NVIDIA_ROOT_URL}/machine-learning/repos/ubu=
ntu1604/x86_64/"

    apt-get -y install x11-common
    apt-get -y install xserver-xorg-core
    apt-get -y install cmake
    apt-get -y install make
    apt-get -y install dkms
    apt-get -y install linux-libc-dev
    apt-get -y install libc6-dev
    apt-get -y install lib32gcc1
    apt-get -y install libc6-i386
    apt-get -y install libgl1
    apt-get -y install libwayland-client0
    apt-get -y install libwayland-server0
    apt-get -y install pkg-config
    apt-get -y install screen-resolution-extra
    apt-get -y install libvdpau1
    apt-get -y install libatk1.0-0
    apt-get -y install libcairo-gobject2
    apt-get -y install libcairo2
    apt-get -y install libfontconfig1
    apt-get -y install libgdk-pixbuf2.0-0
    apt-get -y install libgtk-3-0
    apt-get -y install libgtk2.0-0
    apt-get -y install libjansson4
    apt-get -y install freeglut3-dev
    apt-get -y install libx11-dev
    apt-get -y install libxmu-dev
    apt-get -y install libxi-dev
    apt-get -y install libglu1-mesa
    apt-get -y install libglu1-mesa-dev
    apt-get -y install default-jre

    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-367_367.48-0ubuntu1_amd64.deb=
"
    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-367-dev_367.48-0ubuntu1_amd64=
.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-modprobe_367.48-0ubuntu1_amd6=
4.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/libcuda1-367_367.48-0ubuntu1_amd64.d=
eb"
    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-libopencl1-367_367.48-0ubuntu=
1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-opencl-icd-367_367.48-0ubuntu=
1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/libxnvctrl0_367.48-0ubuntu1_amd64.de=
b"
    wget --wait=3D10 "${CUDA_REPO_URL}/nvidia-settings_367.48-0ubuntu1_amd6=
4.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-drivers_367.48-1_amd64.deb"

    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-license-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-misc-headers-8-0_8.0.44-1_amd64=
.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-core-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cudart-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-driver-dev-8-0_8.0.44-1_amd64.d=
eb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cudart-dev-8-0_8.0.44-1_amd64.d=
eb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-command-line-tools-8-0_8.0.44-1=
_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-nvrtc-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-nvrtc-dev-8-0_8.0.44-1_amd64.de=
b"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-nvml-dev-8-0_8.0.44-1_amd64.deb=
"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-nvgraph-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-nvgraph-dev-8-0_8.0.44-1_amd64.=
deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cusolver-8-0_8.0.44-1_amd64.deb=
"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cusolver-dev-8-0_8.0.44-1_amd64=
.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cublas-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cublas-dev-8-0_8.0.44-1_amd64.d=
eb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cufft-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cufft-dev-8-0_8.0.44-1_amd64.de=
b"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-curand-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-curand-dev-8-0_8.0.44-1_amd64.d=
eb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cusparse-8-0_8.0.44-1_amd64.deb=
"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-cusparse-dev-8-0_8.0.44-1_amd64=
.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-npp-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-npp-dev-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-samples-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-documentation-8-0_8.0.44-1_amd6=
4.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-visual-tools-8-0_8.0.44-1_amd64=
.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-toolkit-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-runtime-8-0_8.0.44-1_amd64.deb"
    wget --wait=3D10 "${CUDA_REPO_URL}/cuda-demo-suite-8-0_8.0.44-1_amd64.d=
eb"

    wget --wait=3D10 "${ML_REPO_URL}/libcudnn5_5.1.10-1+cuda8.0_amd64.deb"
    wget --wait=3D10 "${ML_REPO_URL}/libcudnn5-dev_5.1.10-1+cuda8.0_amd64.d=
eb"

    wget --wait=3D10 "${ML_REPO_URL}/libnccl1_1.2.3-1+cuda8.0_amd64.deb"
    wget --wait=3D10 "${ML_REPO_URL}/libnccl-dev_1.2.3-1+cuda8.0_amd64.deb"

    wget --wait=3D10 "${ML_REPO_URL}/caffe-nv_0.15.13-1ubuntu16.04+cuda8.0_=
amd64.deb"
    wget --wait=3D10 "${ML_REPO_URL}/python-caffe-nv_0.15.13-1ubuntu16.04+c=
uda8.0_amd64.deb"
    wget --wait=3D10 "${ML_REPO_URL}/libcaffe-nv0_0.15.13-1ubuntu16.04+cuda=
8.0_amd64.deb"
    wget --wait=3D10 "${ML_REPO_URL}/caffe-nv-tools_0.15.13-1ubuntu16.04+cu=
da8.0_amd64.deb"

    dpkg -i nvidia-367_367.48-0ubuntu1_amd64.deb
    dpkg -i nvidia-367-dev_367.48-0ubuntu1_amd64.deb
    dpkg -i nvidia-modprobe_367.48-0ubuntu1_amd64.deb
    dpkg -i libcuda1-367_367.48-0ubuntu1_amd64.deb
    dpkg -i nvidia-libopencl1-367_367.48-0ubuntu1_amd64.deb
    dpkg -i nvidia-opencl-icd-367_367.48-0ubuntu1_amd64.deb
    dpkg -i libxnvctrl0_367.48-0ubuntu1_amd64.deb
    dpkg -i nvidia-settings_367.48-0ubuntu1_amd64.deb
    dpkg -i cuda-drivers_367.48-1_amd64.deb

    dpkg -i cuda-license-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-misc-headers-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-core-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cudart-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-driver-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cudart-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-command-line-tools-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-nvrtc-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-nvrtc-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-nvml-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-nvgraph-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-nvgraph-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cusolver-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cusolver-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cublas-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cublas-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cufft-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cufft-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-curand-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-curand-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cusparse-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-cusparse-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-npp-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-npp-dev-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-samples-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-documentation-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-visual-tools-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-toolkit-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-runtime-8-0_8.0.44-1_amd64.deb
    dpkg -i cuda-demo-suite-8-0_8.0.44-1_amd64.deb

    dpkg -i libcudnn5_5.1.10-1+cuda8.0_amd64.deb
    dpkg -i libcudnn5-dev_5.1.10-1+cuda8.0_amd64.deb

    dpkg -i libnccl1_1.2.3-1+cuda8.0_amd64.deb
    dpkg -i libnccl-dev_1.2.3-1+cuda8.0_amd64.deb

    apt-get -y install libprotobuf-dev libleveldb-dev libsnappy-dev libopen=
cv-dev libhdf5-serial-dev protobuf-compiler libgflags-dev libgoogle-glog-de=
v liblmdb-dev libatlas-base-dev git
    apt-get -y install --no-install-recommends libboost-all-dev
    apt-get -y install libopenblas-base
    apt-get -y install liblapack3

    dpkg -i libcaffe-nv0_0.15.13-1ubuntu16.04+cuda8.0_amd64.deb
    dpkg -i caffe-nv_0.15.13-1ubuntu16.04+cuda8.0_amd64.deb
    dpkg -i caffe-nv-tools_0.15.13-1ubuntu16.04+cuda8.0_amd64.deb

%files

%runscript

%test

    export PATH=3D"/usr/local/cuda-8.0/bin${PATH:+:${PATH}}"
    export LD_LIBRARY_PATH=3D"/usr/local/cuda-8.0/lib64${LD_LIBRARY_PATH:+:=
${LD_LIBRARY_PATH}}"
    nvcc --version

________________________________
From: Dmitri Chebotarov [4di...@gmail.com]
Sent: Tuesday, July 11, 2017 1:57 PM
To: singu...@lbl.gov
Subject: Re: [Singularity] Caffe

Hi Vanessa

No, I'm not using -nv option. For some reason -nv option fails in my case. =
I copied libnvidia-ml.so.375.20 (current driver) from the host and built Ca=
ffe this way. I'm not sure if -nv would work in my case, since workstation =
where I'm building Singularity doesn't have NVIDIA. If -nv option improves =
GPU integration then I'll work on getting it to work.


Marty, let me know how your test goes.
This is my 'cmake' command for nvcaffe-0.16.2:

cmake -DCMAKE_INSTALL_PREFIX=3D/usr/local/nvcaffe-0.16.2 -DBLAS=3Dopen -DUS=
E_NCCL=3DON -DBoost_NO_BOOST_CMAKE=3DTRUE -DBoost_NO_SYSTEM_PATHS=3DTRUE -D=
BOOST_ROOT:PATHNAME=3D/usr/local -DBoost_LIBRARY_DIRS:FILEPATH=3D/usr/local=
/lib -DNVML_INCLUDE_DIR=3D/cm/shared/apps/cuda80/toolkit/8.0.61/include -DN=
VML_LIBRARY=3D/usr/local/lib64/libnvidia-ml.so.375.20 -DTEST_FP16=3DON

I'm also seeing higher memory usage (I have a different post in the group) =
between older Caffee (not using Singularity) and latest Caffe with Singular=
ity. Basically we needed to reduce batch_size significantly to run Singular=
ity Caffe, and I was told it's not desired. Otherwise Caffe fails with 'out=
-of-memory' error.

Thank you.


On Tue, Jul 11, 2017 at 1:55 PM, vanessa s <vso...@gmail.com<mailto:vso...@=
gmail.com>> wrote:
Hey Dmitri,

If Martin doesn't figure it out - just for a sanity check - are you using t=
he -nv option to support GPU?

Best,

Vanessa

On Tue, Jul 11, 2017 at 11:07 AM, Dmitri Chebotarov <4di...@gmail.com<mailt=
o:4di...@gmail.com>> wrote:
Hi

I have built few Singularity containers with Caffe, NVIDIA and Berkeley for=
ks. When I submit a Coffe job to GPU nodes, it runs OK for few minutes, I s=
ee GPU usage in 90%, but then usage goes to 0% and job is idle.

I'm not sure if it's Singularity, Caffe or user's code to blame. I cannot r=
un Caffe directry b/c cluster's older OS (hence use of Singularity).

Thanks

--
You received this message because you are subscribed to the Google Groups "=
singularity" group.
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to singu...@lbl.gov<mailto:singularity%...@lbl.gov>.



--
Vanessa Villamia Sochat
Stanford University '16
(603) 321-0676<tel:(603)%20321-0676>

--
You received this message because you are subscribed to the Google Groups "=
singularity" group.
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to singu...@lbl.gov<mailto:singu...@lbl.gov>.


--
You received this message because you are subscribed to the Google Groups "=
singularity" group.
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to singu...@lbl.gov<mailto:singu...@lbl.gov>.

--_000_B58197C146EC324AA00A2A07DC0826027028711EXMAILMBXBT1ADUC_
Content-Type: text/html; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable

<html dir=3D"ltr">
<head>
<meta http-equiv=3D"Content-Type" content=3D"text/html; charset=3Diso-8859-=
1">
<style type=3D"text/css" id=3D"owaParaStyle">P {margin-top:0;margin-bottom:=
0;}</style>
</head>
<body fpstyle=3D"1" ocsi=3D"0">
<div style=3D"direction: ltr;font-family: Tahoma;color: #000000;font-size: =
10pt;">Dimitri,<br>
<br>
I'm currently waiting on the ImageNet dataset to download. And it doesn't l=
ook like it's going to complete anytime soon --- they must be throttling th=
e download on their side. Therefore, it might be another day or so before I=
 get back to giving Caffe a good
 test. However, if you want to give my container a try on your problem, fee=
l free --- here's the definition file [1]. It's based on an older version o=
f Nvcaffe already packaged by Nvidia. Note, you'll probably want to change =
the driver version to match the
 one deployed on the system you intend to run the container. We're still ru=
nning an older version of Singularity (v2.2) as well as an older Nvidia dri=
ver (v367.48), so we haven't had the chance to try the --nv option yet. But=
 probably safe to make everything
 match up anyway. <br>
<br>
Marty<br>
<br>
P.S. I'm basically trying to reproduce Nvidia's own benchmarks: <a href=3D"=
http://www.nvidia.com/object/caffe-deep-learning-framework.html" target=3D"=
_blank">
http://www.nvidia.com/object/caffe-deep-learning-framework.html</a> <br>
<br>
[1]<br>
<br>
Bootstrap: debootstrap<br>
MirrorURL: http://us.archive.ubuntu.com/ubuntu<br>
OSVersion: xenial<br>
<br>
%labels<br>
<br>
&nbsp;&nbsp;&nbsp; AUTHOR_NAME Marty Kandes<br>
&nbsp;&nbsp;&nbsp; AUTHOR_EMAIL mka...@sdsc.edu<br>
&nbsp;&nbsp;&nbsp; OPERATING_SYSTEM_NAME ubuntu<br>
&nbsp;&nbsp;&nbsp; OPERATING_SYSTEM_VERSION 16.04<br>
&nbsp;&nbsp;&nbsp; APPLICATION_NAME caffe-nv<br>
&nbsp;&nbsp;&nbsp; APPLICATION_VERSION 0.15.13<br>
&nbsp;&nbsp;&nbsp; SYSTEM_NAME comet<br>
&nbsp;&nbsp;&nbsp; SYSTEM_SINGULARITY_VERSION 2.2<br>
&nbsp;&nbsp;&nbsp; VERSION 0.0.1<br>
<br>
%setup<br>
<br>
%environment<br>
<br>
%post -c /bin/bash<br>
<br>
&nbsp;&nbsp;&nbsp; declare -r MIRRORURL=3D'http://us.archive.ubuntu.com/ubu=
ntu'<br>
&nbsp;&nbsp;&nbsp; declare -r OSVERSION=3D'xenial'<br>
<br>
&nbsp;&nbsp;&nbsp; apt-get -y install ubuntu-minimal<br>
&nbsp;&nbsp;&nbsp; apt-get -y install ubuntu-standard<br>
&nbsp;&nbsp;&nbsp; apt-get -y install ubuntu-server<br>
<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
} restricted&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
} universe&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
} multiverse&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-updates main&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-updates restricted&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-updates universe&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-updates multiverse&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-backports main&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-backports restricted&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-backports universe&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-backports multiverse&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-security main&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-security restricted&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-security universe&quot;<br>
&nbsp;&nbsp;&nbsp; add-apt-repository -y &quot;deb ${MIRRORURL} ${OSVERSION=
}-security multiverse&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; apt-get -y update &amp;&amp; apt-get -y upgrade<br>
<br>
&nbsp;&nbsp;&nbsp; mkdir /cvmfs /oasis /projects /scratch<br>
<br>
&nbsp;&nbsp;&nbsp; declare -r NVIDIA_ROOT_URL=3D'http://developer.download.=
nvidia.com/compute'<br>
&nbsp;&nbsp;&nbsp; declare -r CUDA_REPO_URL=3D&quot;${NVIDIA_ROOT_URL}/cuda=
/repos/ubuntu1604/x86_64&quot;<br>
&nbsp;&nbsp;&nbsp; declare -r ML_REPO_URL=3D&quot;${NVIDIA_ROOT_URL}/machin=
e-learning/repos/ubuntu1604/x86_64/&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; apt-get -y install x11-common<br>
&nbsp;&nbsp;&nbsp; apt-get -y install xserver-xorg-core<br>
&nbsp;&nbsp;&nbsp; apt-get -y install cmake<br>
&nbsp;&nbsp;&nbsp; apt-get -y install make<br>
&nbsp;&nbsp;&nbsp; apt-get -y install dkms<br>
&nbsp;&nbsp;&nbsp; apt-get -y install linux-libc-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libc6-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install lib32gcc1<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libc6-i386<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libgl1<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libwayland-client0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libwayland-server0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install pkg-config<br>
&nbsp;&nbsp;&nbsp; apt-get -y install screen-resolution-extra<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libvdpau1<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libatk1.0-0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libcairo-gobject2<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libcairo2<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libfontconfig1<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libgdk-pixbuf2.0-0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libgtk-3-0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libgtk2.0-0<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libjansson4<br>
&nbsp;&nbsp;&nbsp; apt-get -y install freeglut3-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libx11-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libxmu-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libxi-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libglu1-mesa<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libglu1-mesa-dev<br>
&nbsp;&nbsp;&nbsp; apt-get -y install default-jre<br>
<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-367_367.4=
8-0ubuntu1_amd64.deb&quot; <br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-367-dev_3=
67.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-modprobe_=
367.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/libcuda1-367_367=
.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-libopencl=
1-367_367.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-opencl-ic=
d-367_367.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/libxnvctrl0_367.=
48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/nvidia-settings_=
367.48-0ubuntu1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-drivers_367=
.48-1_amd64.deb&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-license-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-misc-header=
s-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-core-8-0_8.=
0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cudart-8-0_=
8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-driver-dev-=
8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cudart-dev-=
8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-command-lin=
e-tools-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-nvrtc-8-0_8=
.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-nvrtc-dev-8=
-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-nvml-dev-8-=
0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-nvgraph-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-nvgraph-dev=
-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cusolver-8-=
0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cusolver-de=
v-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cublas-8-0_=
8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cublas-dev-=
8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cufft-8-0_8=
.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cufft-dev-8=
-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-curand-8-0_=
8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-curand-dev-=
8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cusparse-8-=
0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-cusparse-de=
v-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-npp-8-0_8.0=
.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-npp-dev-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-samples-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-documentati=
on-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-visual-tool=
s-8-0_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-toolkit-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-runtime-8-0=
_8.0.44-1_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${CUDA_REPO_URL}/cuda-demo-suite-=
8-0_8.0.44-1_amd64.deb&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/libcudnn5_5.1.10-1=
&#43;cuda8.0_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/libcudnn5-dev_5.1.=
10-1&#43;cuda8.0_amd64.deb&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/libnccl1_1.2.3-1&#=
43;cuda8.0_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/libnccl-dev_1.2.3-=
1&#43;cuda8.0_amd64.deb&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/caffe-nv_0.15.13-1=
ubuntu16.04&#43;cuda8.0_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/python-caffe-nv_0.=
15.13-1ubuntu16.04&#43;cuda8.0_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/libcaffe-nv0_0.15.=
13-1ubuntu16.04&#43;cuda8.0_amd64.deb&quot;<br>
&nbsp;&nbsp;&nbsp; wget --wait=3D10 &quot;${ML_REPO_URL}/caffe-nv-tools_0.1=
5.13-1ubuntu16.04&#43;cuda8.0_amd64.deb&quot;<br>
<br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-367_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-367-dev_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-modprobe_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i libcuda1-367_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-libopencl1-367_367.48-0ubuntu1_amd64.deb<=
br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-opencl-icd-367_367.48-0ubuntu1_amd64.deb<=
br>
&nbsp;&nbsp;&nbsp; dpkg -i libxnvctrl0_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i nvidia-settings_367.48-0ubuntu1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-drivers_367.48-1_amd64.deb<br>
<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-license-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-misc-headers-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-core-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cudart-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-driver-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cudart-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-command-line-tools-8-0_8.0.44-1_amd64.deb<b=
r>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-nvrtc-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-nvrtc-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-nvml-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-nvgraph-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-nvgraph-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cusolver-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cusolver-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cublas-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cublas-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cufft-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cufft-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-curand-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-curand-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cusparse-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-cusparse-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-npp-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-npp-dev-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-samples-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-documentation-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-visual-tools-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-toolkit-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-runtime-8-0_8.0.44-1_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i cuda-demo-suite-8-0_8.0.44-1_amd64.deb<br>
<br>
&nbsp;&nbsp;&nbsp; dpkg -i libcudnn5_5.1.10-1&#43;cuda8.0_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i libcudnn5-dev_5.1.10-1&#43;cuda8.0_amd64.deb <br=
>
<br>
&nbsp;&nbsp;&nbsp; dpkg -i libnccl1_1.2.3-1&#43;cuda8.0_amd64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i libnccl-dev_1.2.3-1&#43;cuda8.0_amd64.deb<br>
<br>
&nbsp;&nbsp;&nbsp; apt-get -y install libprotobuf-dev libleveldb-dev libsna=
ppy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler libgflags-dev li=
bgoogle-glog-dev liblmdb-dev libatlas-base-dev git<br>
&nbsp;&nbsp;&nbsp; apt-get -y install --no-install-recommends libboost-all-=
dev <br>
&nbsp;&nbsp;&nbsp; apt-get -y install libopenblas-base<br>
&nbsp;&nbsp;&nbsp; apt-get -y install liblapack3<br>
<br>
&nbsp;&nbsp;&nbsp; dpkg -i libcaffe-nv0_0.15.13-1ubuntu16.04&#43;cuda8.0_am=
d64.deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i caffe-nv_0.15.13-1ubuntu16.04&#43;cuda8.0_amd64.=
deb<br>
&nbsp;&nbsp;&nbsp; dpkg -i caffe-nv-tools_0.15.13-1ubuntu16.04&#43;cuda8.0_=
amd64.deb<br>
<br>
%files<br>
<br>
%runscript<br>
<br>
%test<br>
<br>
&nbsp;&nbsp;&nbsp; export PATH=3D&quot;/usr/local/cuda-8.0/bin${PATH:&#43;:=
${PATH}}&quot;<br>
&nbsp;&nbsp;&nbsp; export LD_LIBRARY_PATH=3D&quot;/usr/local/cuda-8.0/lib64=
${LD_LIBRARY_PATH:&#43;:${LD_LIBRARY_PATH}}&quot;<br>
&nbsp;&nbsp;&nbsp; nvcc --version<br>
<br>
<div style=3D"font-family: Times New Roman; color: #000000; font-size: 16px=
">
<hr tabindex=3D"-1">
<div id=3D"divRpF590300" style=3D"direction: ltr;"><font size=3D"2" face=3D=
"Tahoma" color=3D"#000000"><b>From:</b> Dmitri Chebotarov [4di...@gmail.com=
]<br>
<b>Sent:</b> Tuesday, July 11, 2017 1:57 PM<br>
<b>To:</b> singu...@lbl.gov<br>
<b>Subject:</b> Re: [Singularity] Caffe<br>
</font><br>
</div>
<div></div>
<div>
<div dir=3D"ltr">Hi Vanessa
<div><br>
</div>
<div>No, I'm not using -nv option. For some reason -nv option fails in my c=
ase. I copied libnvidia-ml.so.375.20 (current driver) from the host and bui=
lt Caffe this way. I'm not sure if -nv would work in my case, since worksta=
tion where I'm building Singularity
 doesn't have NVIDIA. If -nv option improves GPU integration then I'll work=
 on getting it to work.</div>
<div><br>
</div>
<div><br class=3D"gmail-Apple-interchange-newline">
Marty, let me know how your test goes.&nbsp;<br>
</div>
<div>This is my 'cmake' command for nvcaffe-0.16.2:<br>
</div>
<div><br>
</div>
<div>cmake -DCMAKE_INSTALL_PREFIX=3D/usr/local/nvcaffe-0.16.2 -DBLAS=3Dopen=
 -DUSE_NCCL=3DON -DBoost_NO_BOOST_CMAKE=3DTRUE -DBoost_NO_SYSTEM_PATHS=3DTR=
UE -DBOOST_ROOT:PATHNAME=3D/usr/local -DBoost_LIBRARY_DIRS:FILEPATH=3D/usr/=
local/lib -DNVML_INCLUDE_DIR=3D/cm/shared/apps/cuda80/toolkit/8.0.61/includ=
e
 -DNVML_LIBRARY=3D/usr/local/lib64/libnvidia-ml.so.375.20 -DTEST_FP16=3DON<=
br>
</div>
<div><br>
</div>
<div>I'm also seeing higher memory usage (I have a different post in the gr=
oup) between older Caffee (not using Singularity) and latest Caffe with Sin=
gularity. Basically we needed to reduce batch_size significantly to run Sin=
gularity Caffe, and I was told it's
 not desired. Otherwise Caffe fails with 'out-of-memory' error.&nbsp;</div>
<div><br>
</div>
<div>Thank you.&nbsp;</div>
<div><br>
</div>
</div>
<div class=3D"gmail_extra"><br>
<div class=3D"gmail_quote">On Tue, Jul 11, 2017 at 1:55 PM, vanessa s <span=
 dir=3D"ltr">
&lt;<a href=3D"mailto:vso...@gmail.com" target=3D"_blank">vso...@gmail.com<=
/a>&gt;</span> wrote:<br>
<blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex; border-left:1=
px #ccc solid; padding-left:1ex">
<div dir=3D"ltr">Hey Dmitri,
<div><br>
</div>
<div>If Martin doesn't figure it out - just for a sanity check - are you us=
ing the -nv option to support GPU?</div>
<div><br>
</div>
<div>Best,</div>
<div><br>
</div>
<div>Vanessa</div>
</div>
<div class=3D"gmail_extra">
<div>
<div class=3D"h5"><br>
<div class=3D"gmail_quote">On Tue, Jul 11, 2017 at 11:07 AM, Dmitri Chebota=
rov <span dir=3D"ltr">
&lt;<a href=3D"mailto:4di...@gmail.com" target=3D"_blank">4di...@gmail.com<=
/a>&gt;</span> wrote:<br>
<blockquote class=3D"gmail_quote" style=3D"margin:0 0 0 .8ex; border-left:1=
px #ccc solid; padding-left:1ex">
Hi<br>
<br>
I have built few Singularity containers with Caffe, NVIDIA and Berkeley for=
ks. When I submit a Coffe job to GPU nodes, it runs OK for few minutes, I s=
ee GPU usage in 90%, but then usage goes to 0% and job is idle.<br>
<br>
I'm not sure if it's Singularity, Caffe or user's code to blame. I cannot r=
un Caffe directry b/c cluster's older OS (hence use of Singularity).<br>
<br>
Thanks<br>
<span class=3D"m_-8307816094766804390HOEnZb"><font color=3D"#888888"><br>
--<br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to
<a href=3D"mailto:singularity%...@lbl.gov" target=3D"_blank">singularity&#4=
3;unsubscribe@lbl.go<wbr>v</a>.<br>
</font></span></blockquote>
</div>
<br>
<br clear=3D"all">
<div><br>
</div>
</div>
</div>
<span class=3D"HOEnZb"><font color=3D"#888888">-- <br>
<div class=3D"m_-8307816094766804390gmail_signature">Vanessa Villamia Socha=
t<br>
Stanford University '16<br>
<div>
<div>
<div><a href=3D"tel:(603)%20321-0676" value=3D"&#43;16033210676" target=3D"=
_blank">(603) 321-0676</a></div>
</div>
</div>
</div>
</font></span></div>
<div class=3D"HOEnZb">
<div class=3D"h5">
<p></p>
-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to
<a href=3D"mailto:singularity&#43;unsu...@lbl.gov" target=3D"_blank">singul=
arity&#43;unsubscribe@lbl.<wbr>gov</a>.<br>
</div>
</div>
</blockquote>
</div>
<br>
</div>
<p></p>
-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to
<a href=3D"mailto:singularity&#43;unsu...@lbl.gov" target=3D"_blank">singul=
arity&#43;unsu...@lbl.gov</a>.<br>
</div>
</div>
</div>
</body>
</html>

--_000_B58197C146EC324AA00A2A07DC0826027028711EXMAILMBXBT1ADUC_--
