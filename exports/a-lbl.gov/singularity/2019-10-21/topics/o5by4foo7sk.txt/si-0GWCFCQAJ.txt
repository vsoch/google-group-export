X-Received: by 10.99.173.15 with SMTP id g15mr11248708pgf.109.1512957878099;
        Sun, 10 Dec 2017 18:04:38 -0800 (PST)
X-BeenThere: singularity@lbl.gov
Received: by 10.98.198.129 with SMTP id x1ls1147455pfk.2.gmail; Sun, 10 Dec
 2017 18:04:37 -0800 (PST)
X-Received: by 10.99.160.96 with SMTP id u32mr36981388pgn.25.1512957877043;
        Sun, 10 Dec 2017 18:04:37 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1512957877; cv=none;
        d=google.com; s=arc-20160816;
        b=buQa9twjh6VksVVceYX8E5N0XpdkBawgt1JQ71vQzDhn9PcOgr/6vnIGJt3MUtEqku
         s7rLEJoRsNp2k3YGJ85WpNjovtXJb5BYuMSE8jWXvUK0hjGNTT1qw01xQgUbvh5/pEtw
         OY5UNd4DqWQkHZbNkQzCNJ2Bxx5OU11UDq8Le25HqBS+t+QcD3oYKAf/M+jGMnQR593I
         a1LwWnsplWk5Ky/QAZ7CS3L9+VqpPXA8pVMwQwLDAEUp6jiS52WZlgJcO7jgDFStdxof
         CxQXJf0BINOK8snxt9YmjiZIu+i3QMq1/AVWNHVSvF1+tTlN/Nb0m8v8e1TkxTjhh/Sz
         6TfA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=to:subject:message-id:date:from:references:in-reply-to:mime-version
         :dkim-signature:arc-authentication-results;
        bh=mzuen3qlnInRcllkQxzKtHp5jNQGS5JG118Sr7TLJzs=;
        b=mEezKZdGcQwnuYCmjJllobtlmVFGOtJFdhkR7crhOzYw9VZjAemW3RmhuTeeppCFtH
         oa/5WAu0buIWL9f3s/yVszT8ocbvDepskLXiUTNL1nmZ8211wDv8J7kHV4HxdGUAmHt/
         yKJR1yRWBHtepC3Dortoe/pN65lE14xOezi1GtO3+EAJRch/RssSR5Jiibb6SUMnUIMf
         LJtuWuI18TE1h8HVoJ7yHIoyo1p9IfVtLWfle/AIV8vi6nIFH6pRUnX80pku0aRHvBmP
         Kd7nDBwK9YWMK9COJ+MxV+YdtNPI5XqjVQk/QNX/NfBeBMFeAF5902T9OU4JHd+aYv00
         wSnw==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass head...@computecanada-ca.20150623.gappssmtp.com header.s=20150623 header.b=gP6LQvT2;
       spf=pass (google.com: domain of asoka....@computecanada.ca designates 74.125.82.177 as permitted sender) smtp.mailfrom=asoka....@computecanada.ca
Return-Path: <asoka....@computecanada.ca>
Received: from fe4.lbl.gov (fe4.lbl.gov. [128.3.41.71])
        by mx.google.com with ESMTP id b4si9270963plb.2.2017.12.10.18.04.36
        for <singu...@lbl.gov>;
        Sun, 10 Dec 2017 18:04:36 -0800 (PST)
Received-SPF: pass (google.com: domain of asoka....@computecanada.ca designates 74.125.82.177 as permitted sender) client-ip=74.125.82.177;
Authentication-Results: mx.google.com;
       dkim=pass head...@computecanada-ca.20150623.gappssmtp.com header.s=20150623 header.b=gP6LQvT2;
       spf=pass (google.com: domain of asoka....@computecanada.ca designates 74.125.82.177 as permitted sender) smtp.mailfrom=asoka....@computecanada.ca
X-Ironport-SBRS: 3.4
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A2EGAgAL5y1ahrFSfUpYAx0BAQUBCwGCS?=
 =?us-ascii?q?kUDgRJ0JweDcwiBBDKXSR6BfYMLhESBJotHgmSBIgMZQAMiAQyBCVOCa08ChFg?=
 =?us-ascii?q?HQxQBAQEBAQEBAQEBAhABAQEICwsIKC+COAUCAQIaBglLJjEBAQEBAQEBAQEBA?=
 =?us-ascii?q?QEBAQEBGgIIJw8SAhgBAQEDARoJHQEBDCwPCQILDSABCQICIQEPAwEFARwOBwQ?=
 =?us-ascii?q?BHASINYE6Aw0IBQuJKJEcQIsiboIngwkBAQWEIA2DJgEBCAEBAQEBAQEBGAgSg?=
 =?us-ascii?q?1aBYSqDPgGDK4JqggIBEgELIBUmgk6CY4pSiFaGKIkJPYd5h1pShHyCN0KBGo9?=
 =?us-ascii?q?QjQo9QIRkAYNeGR+BFw8nSQ0ubkyBJAaBcQmCECoPEAwZgW8gNwEHhzAOGDAxg?=
 =?us-ascii?q?UABAQE?=
X-IronPort-AV: E=Sophos;i="5.45,391,1508828400"; 
   d="scan'208,217";a="7139226"
Received: from mail-ot0-f177.google.com ([74.125.82.177])
  by fe4.lbl.gov with ESMTP; 10 Dec 2017 18:04:34 -0800
Received: by mail-ot0-f177.google.com with SMTP id e74so13519866ote.7
        for <singu...@lbl.gov>; Sun, 10 Dec 2017 18:04:34 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=computecanada-ca.20150623.gappssmtp.com; s=20150623;
        h=mime-version:in-reply-to:references:from:date:message-id:subject:to;
        bh=mzuen3qlnInRcllkQxzKtHp5jNQGS5JG118Sr7TLJzs=;
        b=gP6LQvT2YNnhTP2bU+ZIJET1XtCczF+p6bIWg/RRwR+sfF9EtqHPFEkExwJKQ5p0Ty
         msgtdKTnq6l17umShyh0ZMGv5b4AAVFw+5Zfs8kIGzgfvESbQLVCYzzn4UBa+iRlfW5K
         rlLmAsdxqCFtMEtpQCNGcSFkLo9GsklNwskw/hFcx8t1hdZKor5Ab3ThZqLYtPRIHshz
         cvbdq8AfcBWFC01+cvhEfDSLiwLMiS6sONkigKkF2XGkYydVsTxN5OQt5Lxiu8Zcq/ez
         NR17yKIihCoADRW+q/bkOEHfG8H2OBwRuSC4V5PG6U/Zxlt84an9YHsup4QjumpedKl/
         shUQ==
X-Gm-Message-State: AJaThX6R1Xvsff1l12o0Y/ms89O1lajmqcZyYxs0oXq/S1vAqv+NDNqS
	uqIXiQQvueiPj5d0zsX3/Y3EOOyul3YMhctlRY7e+1JA
X-Received: by 10.157.15.205 with SMTP id m13mr32725030otd.389.1512957873856;
 Sun, 10 Dec 2017 18:04:33 -0800 (PST)
MIME-Version: 1.0
Received: by 10.157.14.85 with HTTP; Sun, 10 Dec 2017 18:04:33 -0800 (PST)
In-Reply-To: <CAM=pu+LLLVPEhtO3AQJ-8FsK6nym_xPWskLKH0rKTb8fYBA3bQ@mail.gmail.com>
References: <fc143246-9300-4978-9072-5a2de6d5f29a@lbl.gov> <CAM=pu+J5a6VgZGqLTOVdpBmFOa-CQaysLdHyZuXYtuGQ3+Zyag@mail.gmail.com>
 <CAM4qrSqcf9bLLqep57kT_sKR5CiEYUUU1WxdraGyJFmJ_rLQ5A@mail.gmail.com>
 <CAM=pu+KOO32un+0J5Q9kj6wqB8M8NTxjE3peUNt6d++SZ69xBA@mail.gmail.com>
 <CAM4qrSqSD-2XL4nfwWpMwv_CXHhfHnnBbWi3PrpQJxj5bVGn2Q@mail.gmail.com> <CAM=pu+LLLVPEhtO3AQJ-8FsK6nym_xPWskLKH0rKTb8fYBA3bQ@mail.gmail.com>
From: Asoka De Silva <asoka....@computecanada.ca>
Date: Sun, 10 Dec 2017 18:04:33 -0800
Message-ID: <CAM4qrSpT-MSCYT6JFoOgAsJ9nN9pZpOiL8qr-v9fcxZ_-OGCCw@mail.gmail.com>
Subject: Re: [Singularity] how to source a script and remain in the bash shell
 of the container
To: singularity@lbl.gov
Content-Type: multipart/alternative; boundary="001a113d0c78a1b7d7056006f48d"

--001a113d0c78a1b7d7056006f48d
Content-Type: text/plain; charset="UTF-8"

Hi Vanessa,

Thanks but bootstrap is not going to be optimal here as we don't want every
user / instance doing that.  Would be nicer and  easier to just ask the
maintainer to fix / include the %appenv context you referred to earlier.

(I tried singularity version 2.4.1 but no luck.)

As to your queries, I am not very successful with inspecting the images and
the dir structure looks different (no /.singularity dir)

Here are the results:

[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 inspect -e /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img
ERROR: The Singularity metadata directory does not exist in image
ABORT: Aborting with RETVAL=255

[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 inspect -r /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img
ERROR: The Singularity metadata directory does not exist in image
ABORT: Aborting with RETVAL=255

[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img cat
/.singularity.d/runscript
cat: /.singularity.d/runscript: No such file or directory

[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img ls
 /.singularity.d/
ls: cannot access /.singularity.d/: No such file or directory

In fact:
[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img ls -a  /
. bin  etc lost+found  opt      selinux   usr
.. creation-date-2017101101  gpfs media     proc     singularity  var
.exec cvmfs  home misc     root     srv
.run dev  lib mnt     sbin     sys
.shell environment  lib64  net     scratch  tmp


but:



[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img cat
/.run
#!/bin/bash
. /environment
if test -x /singularity; then
    exec /singularity "$@"
else
    echo "No Singularity runscript found, executing /bin/sh"
    exec /bin/sh "$@"
fi


[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img cat
/.exec
#!/bin/bash
. /environment
exec "$@"


[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img cat
/.shell
#!/bin/bash
. /environment
if test -n "$\SHELL" -a -x "$SHELL"; then
    exec "$SHELL" "$@"
else
    echo "ERROR: Shell does not exist in container: $SHELL" 1>&2
    echo "ERROR: Using /bin/sh instead..." 1>&2
fi
if test -x /bin/sh; then
    SHELL=/bin/sh
    export SHELL
    exec /bin/sh "$@"
else
    echo "ERROR: /bin/sh does not exist in container" 1>&2
fi
exit 1



[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1  exec  -B /cvmfs/
atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch
,/cvmfs/sft.cern.ch /cvmfs/
atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img cat
/environment
# Define any environment init code here

if test -z "$SINGULARITY_INIT"; then
    PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
    PS1="Singularity.$SINGULARITY_CONTAINER> $PS1"
    SINGULARITY_INIT=1
    export PATH PS1 SINGULARITY_INIT
fi


A quick test shows that the /.shell file will br problematic.

e.g.if I run it interactive

/.shell
  will produce a new shell env

./shell < hello.sh
  will say Hello and exit to the caller.

I guess I have to contact the maintainer to fix this.


Many thanks for all your help !


regards,
Asoka

On Sun, Dec 10, 2017 at 5:37 PM, v <vso...@gmail.com> wrote:

>
> Hi Vanessa,
>>
>> I am trying to extend the container for other users / use cases so I
>> cannot modify .bashrc / profile or even manually enter it since I am
>> considering making the startup of the container to be transparent to the
>> user.   The end result of this is to provide users with an ATLAS Tier3
>> environment.   I would like to avoid rebuilding it but as a very last
>> resort can can ask if the container developers can build future versions
>> with  %appenv.
>>
>> ah understood. You can also bootstrap their container (use it as a base)
> and add your custom code to it, here are the docs:
>
> http://singularity.lbl.gov/build-localimage
>
>
>> (ATLAS_LOCAL_ROOT_BASE should not be passed to the container unless the
>> container does not define it but this doe snot seem to be the issue as the
>> sourcing will fail if it does not exist.)  If you have /cvmfs available ,
>> you can try it:
>>
>
> I don't have it, unfortunately :(
>
>>
>>
>> e.g.
>>
>> [desilva@cdr818 ~]$ singularity shell  -B /cvmfs/atlas-condb.cern.ch,/cv
>> mfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch,/cvmfs/sft.cern.ch
>> /cvmfs/atlas.cern.ch/repo/containers/images/singularity/x86_
>> 64-centos6.img
>> Singularity: Invoking an interactive shell within container...
>>
>> bash: warning: setlocale: LC_CTYPE: cannot change locale (en_US.UTF-8):
>> No such file or directory
>> bash: warning: setlocale: LC_COLLATE: cannot change locale (en_US.UTF-8):
>> No such file or directory
>> bash: warning: setlocale: LC_MESSAGES: cannot change locale
>> (en_US.UTF-8): No such file or directory
>> bash: warning: setlocale: LC_NUMERIC: cannot change locale (en_US.UTF-8):
>> No such file or directory
>> bash: warning: setlocale: LC_TIME: cannot change locale (en_US.UTF-8): No
>> such file or directory
>> Singularity.x86_64-centos6.img> exit
>> exit
>>
>>
>> notice the prompt shows that you are in the bash env prior to exit.
>>
>> [desilva@cdr818 ~]$ singularity shell  -B /cvmfs/atlas-condb.cern.ch,/cv
>> mfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch,/cvmfs/sft.cern.ch
>> /cvmfs/atlas.cern.ch/repo/containers/images/singularity/x86_
>> 64-centos6.img < mySetup.sh
>> Singularity: Invoking an interactive shell within container...
>>
>> lsetup               lsetup <tool1> [ <tool2> ...] (see lsetup -h):
>>  lsetup agis          ATLAS Grid Information System
>>  lsetup asetup        (or asetup) to setup an Athena release
>>  lsetup atlantis      Atlantis: event display
>>  lsetup eiclient      Event Index
>>  lsetup emi           EMI: grid middleware user interface
>>  lsetup fax           Federated XRootD data storage access (FAX)
>>  lsetup ganga         Ganga: job definition and management client
>>  lsetup lcgenv        lcgenv: setup tools from cvmfs SFT repository
>>  lsetup panda         Panda: Production ANd Distributed Analysis
>>  lsetup pod           Proof-on-Demand (obsolete)
>>  lsetup pyami         pyAMI: ATLAS Metadata Interface python client
>>  lsetup rcsetup       (or rcSetup) to setup an ASG release
>>  lsetup root          ROOT data processing framework
>>  lsetup rucio         distributed data management system client
>>  lsetup sft           setup tools from SFT repo (use lcgenv instead)
>>  lsetup xcache        XRootD local proxy cache
>>  lsetup xrootd        XRootD data access
>> advancedTools        advanced tools menu
>> diagnostics          diagnostic tools menu
>> helpMe               more help
>> printMenu            show this menu
>> showVersions         show versions of installed software
>> [desilva@cdr818 ~]$
>>
>> and above it exits.
>>
>>
>> It sounds like the script must exit and thus exit the shell. Just for
> clarity of information: can you look at the runscript, and envrionment? eg:
>
>
> singularity inspect -e container.simg
> singularity inspect -r container.simg
>
>
> What those scripts are looking at:
>
> singularity exec container.simg cat /.singularity.d/runscript
> #!/bin/sh
>
> exec "/bin/bash"
>
>>
>> singularity exec container.simg cat /.singularity.d/env/90-environment.sh
>
>
>
>
>
>> In fact, make it a very simple script that just does
>>
>> [desilva@cedar5 ~]$ cat -v hello.sh
>> echo "hello"
>>
>>
>> [desilva@cedar5 ~]$
>>
>>
>>
>>
>> and it will do:
>>
>> [desilva@cdr818 ~]$ singularity shell  -B /cvmfs/atlas-condb.cern.ch,/cv
>> mfs/atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch,/cvmfs/sft.cern.ch
>> /cvmfs/atlas.cern.ch/repo/containers/images/singularity/x86_
>> 64-centos6.img < ./hello.sh
>> Singularity: Invoking an interactive shell within container...
>>
>> hello
>> [desilva@cdr818 ~]$
>>
>>
>> i.e. it exists.
>>
>> Yeah that is wonky! I think the best thing to do is start with walking
> through the pieces that are called. Since we don't have the recipe the
> inspection should be a good start. I'm going off to bed but likely others
> can pipe in, and I can help more tomorrow if needed.
>
> Best,
>
> Vanessa
>
>
>> regards,
>> Asoka
>>
>>
>>
>>
>> On Sun, Dec 10, 2017 at 4:38 PM, v <vso...@gmail.com> wrote:
>>
>>> Hey Asoka,
>>>
>>> If you are just using shell, is there any reason you can't source it
>>> after entering the container? You could also have something in a bashrc or
>>> profile that is used from your home, if you don't want to do that. We can
>>> definitely think of other ways - but arguably the best (and more
>>> reproducible way) is to get the build recipe (that %environment section I
>>> was talking about is there) and modify it to be correct. Because if someone
>>> finds your container and needs to do what you did, they would have a hard
>>> time.
>>>
>>> It could also be that the ATLAS_LOCAL_ROOT_BASE isn't being found so
>>> it's not sourcing at all, you can also pass it into the container like
>>> ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase singularity
>>> shell...
>>>
>>> the way you can test that the variable is getting in is to do something
>>> like:
>>>
>>>  singularity exec container.simg env | grep ATLAS_LOCAL_ROOT_BASE
>>>
>>>
>>> and then do the same for the script, maybe use cat to look at it.
>>>
>>>  singularity exec container.simg cat ${ATLAS_LOCAL_ROOT_BASE}/user/
>>> atlasLocalSetup.sh
>>>
>>>
>>> I'm also wondering why the container is exiting if you are shelling. It
>>> would be logical for it to exit on exec or run, but probably not shell. If
>>> there is a source that runs cleanly it should not technically exit. I would
>>> check 1) if there is any exit logic in the source and 2) that you aren't
>>> still actually in the container.
>>>
>>> Best,
>>>
>>> Vanessa
>>>
>>> On Sun, Dec 10, 2017 at 4:27 PM, Asoka De Silva <
>>> asoka....@computecanada.ca> wrote:
>>>
>>>> Hi Vanessa,
>>>>
>>>> Thanks for the super fast reply !
>>>>
>>>> This is a pre-built image and all I can do is to run it.  Sorry for the
>>>> naive question (new at this) but how do I add to the %environment or
>>>> %appenv section or is there a way to override ?
>>>>
>>>> Thanks !
>>>>
>>>> regards,
>>>> Asoka
>>>>
>>>> On Sun, Dec 10, 2017 at 4:18 PM, v <vso...@gmail.com> wrote:
>>>>
>>>>> Hey Asoka,
>>>>>
>>>>> Have you tried including your source lines in the %environment
>>>>> section? That will be sourced when you shell / run etc. the container. If
>>>>> you need it to only be specific to some context (and not source for any
>>>>> shell at all) then you could use a SCI-F app
>>>>> <http://containers-ftw.org/SCI-F/> to do it, eg:
>>>>>
>>>>> %appenv mycontext
>>>>>
>>>>> (write code here)
>>>>>
>>>>>
>>>>> and then when you run/shell
>>>>>
>>>>>            # will source the environment above
>>>>>
>>>>> singularity run --app mycontext container.simg
>>>>>
>>>>>
>>>>>            # will not
>>>>>
>>>>> singularity run container.simg
>>>>>
>>>>>
>>>>> Best,
>>>>>
>>>>> Vanessa
>>>>>
>>>>> On Sun, Dec 10, 2017 at 4:13 PM, Asoka De Silva <
>>>>> asoka....@computecanada.ca> wrote:
>>>>>
>>>>>> Hi,
>>>>>>
>>>>>> $ singularity --version
>>>>>> 2.3.1-dist
>>>>>>
>>>>>>
>>>>>> singularity shell  -B /cvmfs/atlas-condb.cern.ch,/cvmfs/
>>>>>> atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch,/cvmfs/sft.cern.ch
>>>>>> /cvmfs/atlas.cern.ch/repo/containers/images/singularity/x86_
>>>>>> 64-centos6.img
>>>>>>
>>>>>> will result in an interactive bash shell of a singularity container.
>>>>>> What I would like to do is to source a script automatically - e.g. do these
>>>>>> lines, and then continue with the interactive shell:
>>>>>>
>>>>>> cat mySetup.sh
>>>>>>
>>>>>> if [ -z $ATLAS_LOCAL_ROOT_BASE ]; then
>>>>>>   export ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRo
>>>>>> otBase
>>>>>> fi
>>>>>> source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh
>>>>>>
>>>>>>
>>>>>>
>>>>>> Is there a way to do this and continue with the interactive bash
>>>>>> shell env ?  I tried
>>>>>>
>>>>>> echo "source mySetup.sh" | singularity shell -B /cvmfs/
>>>>>> atlas-condb.cern.ch,/cvmfs/atlas-nightlies.cern.ch,/cvmfs/
>>>>>> atlas.cern.ch,/cvmfs/sft.cern.ch /cvmfs/atlas.cern.ch/repo/cont
>>>>>> ainers/images/singularity/x86_64-centos6.img
>>>>>>
>>>>>> and also
>>>>>>
>>>>>> singularity shell -B /cvmfs/atlas-condb.cern.ch,/cvmfs/
>>>>>> atlas-nightlies.cern.ch,/cvmfs/atlas.cern.ch,/cvmfs/sft.cern.ch
>>>>>> /cvmfs/atlas.cern.ch/repo/containers/images/singularity/x86_
>>>>>> 64-centos6.img < mySetup.sh
>>>>>>
>>>>>> but it sources mySetup.sh script and then exits the container.
>>>>>>
>>>>>>
>>>>>> (The container images are not user modifiable.)
>>>>>>
>>>>>>
>>>>>> Thanks in advance for any help !
>>>>>>
>>>>>> regards,
>>>>>> Asoka
>>>>>>
>>>>>> --
>>>>>> You received this message because you are subscribed to the Google
>>>>>> Groups "singularity" group.
>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>> send an email to singu...@lbl.gov.
>>>>>>
>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Vanessa Villamia Sochat
>>>>> Stanford University '16
>>>>> (603) 321-0676
>>>>>
>>>>> --
>>>>> You received this message because you are subscribed to the Google
>>>>> Groups "singularity" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>>> an email to singu...@lbl.gov.
>>>>>
>>>>
>>>> --
>>>> You received this message because you are subscribed to the Google
>>>> Groups "singularity" group.
>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>> an email to singu...@lbl.gov.
>>>>
>>>
>>>
>>>
>>> --
>>> Vanessa Villamia Sochat
>>> Stanford University '16
>>> (603) 321-0676
>>>
>>> --
>>> You received this message because you are subscribed to the Google
>>> Groups "singularity" group.
>>> To unsubscribe from this group and stop receiving emails from it, send
>>> an email to singu...@lbl.gov.
>>>
>>
>> --
>> You received this message because you are subscribed to the Google Groups
>> "singularity" group.
>> To unsubscribe from this group and stop receiving emails from it, send an
>> email to singu...@lbl.gov.
>>
>
>
>
> --
> Vanessa Villamia Sochat
> Stanford University '16
> (603) 321-0676
>
> --
> You received this message because you are subscribed to the Google Groups
> "singularity" group.
> To unsubscribe from this group and stop receiving emails from it, send an
> email to singu...@lbl.gov.
>

--001a113d0c78a1b7d7056006f48d
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr">Hi Vanessa,<div><br></div><div>Thanks but bootstrap is not=
 going to be optimal here as we don&#39;t want every user / instance doing =
that.=C2=A0 Would be nicer and =C2=A0easier to just ask the maintainer to f=
ix / include the %appenv context you referred to earlier.</div><div><br></d=
iv><div><div>(I tried singularity version 2.4.1 but no luck.) =C2=A0</div><=
div><br></div><div>As to your queries, I am not very successful with inspec=
ting the images and the dir structure looks different (no /.singularity dir=
)</div><div><br></div><div>Here are the results:</div><div><br></div><div>[=
desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 inspect -e /cvmfs/<a=
 href=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_64-cen=
tos6.img">atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.i=
mg</a></div><div>ERROR: The Singularity metadata directory does not exist i=
n image</div><div>ABORT: Aborting with RETVAL=3D255</div><div><br></div><di=
v>[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 inspect -r /cvmfs=
/<a href=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_64-=
centos6.img">atlas.cern.ch/repo/containers/images/singularity/x86_64-centos=
6.img</a></div><div>ERROR: The Singularity metadata directory does not exis=
t in image</div><div>ABORT: Aborting with RETVAL=3D255</div><div><br></div>=
<div>[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 =C2=A0exec =C2=
=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch">atlas-condb.cern.ch</a>=
,/cvmfs/<a href=3D"http://atlas-nightlies.cern.ch">atlas-nightlies.cern.ch<=
/a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atlas.cern.ch</a>,/cvmfs/<a hre=
f=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs/<a href=3D"http://atlas.cer=
n.ch/repo/containers/images/singularity/x86_64-centos6.img">atlas.cern.ch/r=
epo/containers/images/singularity/x86_64-centos6.img</a> cat /.singularity.=
d/runscript</div><div>cat: /.singularity.d/runscript: No such file or direc=
tory</div><div><br></div><div>[desilva@cdr818 ~]$ /opt/software/bin/singula=
rity-2.4.1 =C2=A0exec =C2=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch=
">atlas-condb.cern.ch</a>,/cvmfs/<a href=3D"http://atlas-nightlies.cern.ch"=
>atlas-nightlies.cern.ch</a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atlas.=
cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs/<a=
 href=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_64-cen=
tos6.img">atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.i=
mg</a> ls =C2=A0/.singularity.d/ =C2=A0 =C2=A0 =C2=A0 =C2=A0=C2=A0</div><di=
v>ls: cannot access /.singularity.d/: No such file or directory</div><div><=
br></div><div>In fact:</div><div>[desilva@cdr818 ~]$ /opt/software/bin/sing=
ularity-2.4.1 =C2=A0exec =C2=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern=
.ch">atlas-condb.cern.ch</a>,/cvmfs/<a href=3D"http://atlas-nightlies.cern.=
ch">atlas-nightlies.cern.ch</a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atl=
as.cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs=
/<a href=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_64-=
centos6.img">atlas.cern.ch/repo/containers/images/singularity/x86_64-centos=
6.img</a> ls -a =C2=A0/</div><div>.<span class=3D"gmail-Apple-tab-span" sty=
le=3D"white-space:pre">=09</span>bin<span class=3D"gmail-Apple-tab-span" st=
yle=3D"white-space:pre">=09=09=09</span> =C2=A0etc<span class=3D"gmail-Appl=
e-tab-span" style=3D"white-space:pre">=09</span> lost+found =C2=A0opt =C2=
=A0 =C2=A0 =C2=A0selinux<span class=3D"gmail-Apple-tab-span" style=3D"white=
-space:pre">=09</span> =C2=A0 usr</div><div>..<span class=3D"gmail-Apple-ta=
b-span" style=3D"white-space:pre">=09</span>creation-date-2017101101 =C2=A0=
gpfs<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09</spa=
n> media<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09<=
/span> =C2=A0 =C2=A0 proc =C2=A0 =C2=A0 singularity =C2=A0var</div><div>.ex=
ec<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09</span>=
cvmfs<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09=09=
=09</span> =C2=A0home<span class=3D"gmail-Apple-tab-span" style=3D"white-sp=
ace:pre">=09</span> misc<span class=3D"gmail-Apple-tab-span" style=3D"white=
-space:pre">=09</span> =C2=A0 =C2=A0 root =C2=A0 =C2=A0 srv</div><div>.run<=
span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09</span>dev=
<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09=09=09</s=
pan> =C2=A0lib<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre=
">=09</span> mnt<span class=3D"gmail-Apple-tab-span" style=3D"white-space:p=
re">=09</span> =C2=A0 =C2=A0 sbin =C2=A0 =C2=A0 sys</div><div>.shell<span c=
lass=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09</span>environme=
nt<span class=3D"gmail-Apple-tab-span" style=3D"white-space:pre">=09=09</sp=
an> =C2=A0lib64 =C2=A0net<span class=3D"gmail-Apple-tab-span" style=3D"whit=
e-space:pre">=09</span> =C2=A0 =C2=A0 scratch =C2=A0tmp</div><div><br></div=
><div><br></div><div>but:</div><div><br></div><div><br></div><div><br></div=
><div>[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 =C2=A0exec =
=C2=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch">atlas-condb.cern.ch<=
/a>,/cvmfs/<a href=3D"http://atlas-nightlies.cern.ch">atlas-nightlies.cern.=
ch</a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atlas.cern.ch</a>,/cvmfs/<a =
href=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs/<a href=3D"http://atlas.=
cern.ch/repo/containers/images/singularity/x86_64-centos6.img">atlas.cern.c=
h/repo/containers/images/singularity/x86_64-centos6.img</a> cat =C2=A0 /.ru=
n</div><div>#!/bin/bash</div><div>. /environment</div><div>if test -x /sing=
ularity; then</div><div>=C2=A0 =C2=A0 exec /singularity &quot;$@&quot;</div=
><div>else</div><div>=C2=A0 =C2=A0 echo &quot;No Singularity runscript foun=
d, executing /bin/sh&quot;</div><div>=C2=A0 =C2=A0 exec /bin/sh &quot;$@&qu=
ot;</div><div>fi</div><div><br></div><div><br></div><div>[desilva@cdr818 ~]=
$ /opt/software/bin/singularity-2.4.1 =C2=A0exec =C2=A0-B /cvmfs/<a href=3D=
"http://atlas-condb.cern.ch">atlas-condb.cern.ch</a>,/cvmfs/<a href=3D"http=
://atlas-nightlies.cern.ch">atlas-nightlies.cern.ch</a>,/cvmfs/<a href=3D"h=
ttp://atlas.cern.ch">atlas.cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch=
">sft.cern.ch</a> /cvmfs/<a href=3D"http://atlas.cern.ch/repo/containers/im=
ages/singularity/x86_64-centos6.img">atlas.cern.ch/repo/containers/images/s=
ingularity/x86_64-centos6.img</a> cat =C2=A0 /.exec</div><div>#!/bin/bash</=
div><div>. /environment</div><div>exec &quot;$@&quot;</div><div><br></div><=
div><br></div><div>[desilva@cdr818 ~]$ /opt/software/bin/singularity-2.4.1 =
=C2=A0exec =C2=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch">atlas-con=
db.cern.ch</a>,/cvmfs/<a href=3D"http://atlas-nightlies.cern.ch">atlas-nigh=
tlies.cern.ch</a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atlas.cern.ch</a>=
,/cvmfs/<a href=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs/<a href=3D"ht=
tp://atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img">a=
tlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img</a> cat =
=C2=A0 /.shell</div><div>#!/bin/bash</div><div>. /environment</div><div>if =
test -n &quot;$\SHELL&quot; -a -x &quot;$SHELL&quot;; then</div><div>=C2=A0=
 =C2=A0 exec &quot;$SHELL&quot; &quot;$@&quot;</div><div>else</div><div>=C2=
=A0 =C2=A0 echo &quot;ERROR: Shell does not exist in container: $SHELL&quot=
; 1&gt;&amp;2</div><div>=C2=A0 =C2=A0 echo &quot;ERROR: Using /bin/sh inste=
ad...&quot; 1&gt;&amp;2</div><div>fi</div><div>if test -x /bin/sh; then</di=
v><div>=C2=A0 =C2=A0 SHELL=3D/bin/sh</div><div>=C2=A0 =C2=A0 export SHELL</=
div><div>=C2=A0 =C2=A0 exec /bin/sh &quot;$@&quot;</div><div>else</div><div=
>=C2=A0 =C2=A0 echo &quot;ERROR: /bin/sh does not exist in container&quot; =
1&gt;&amp;2</div><div>fi</div><div>exit 1</div><div><br></div><div><br></di=
v><div><br></div><div><div>[desilva@cdr818 ~]$ /opt/software/bin/singularit=
y-2.4.1 =C2=A0exec =C2=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch">a=
tlas-condb.cern.ch</a>,/cvmfs/<a href=3D"http://atlas-nightlies.cern.ch">at=
las-nightlies.cern.ch</a>,/cvmfs/<a href=3D"http://atlas.cern.ch">atlas.cer=
n.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch">sft.cern.ch</a> /cvmfs/<a hr=
ef=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_64-centos=
6.img">atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img<=
/a> cat =C2=A0 /environment</div><div># Define any environment init code he=
re</div><div><br></div><div>if test -z &quot;$SINGULARITY_INIT&quot;; then<=
/div><div>=C2=A0 =C2=A0 PATH=3D$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/loc=
al/bin:/usr/local/sbin</div><div>=C2=A0 =C2=A0 PS1=3D&quot;Singularity.$SIN=
GULARITY_CONTAINER&gt; $PS1&quot;</div><div>=C2=A0 =C2=A0 SINGULARITY_INIT=
=3D1</div><div>=C2=A0 =C2=A0 export PATH PS1 SINGULARITY_INIT</div><div>fi<=
/div></div><div><br></div><div><br></div><div>A quick test shows that the /=
.shell file will br problematic.</div><div><br></div><div>e.g.if I run it i=
nteractive</div><div><br></div><div>/.shell=C2=A0<br></div><div>=C2=A0 will=
 produce a new shell env</div><div><br></div><div>./shell &lt; hello.sh</di=
v><div>=C2=A0 will say Hello and exit to the caller.</div><div><br></div><d=
iv>I guess I have to contact the maintainer to fix this.</div><div><br></di=
v><div><br></div><div>Many thanks for all your help !</div><div><br></div><=
div><br></div></div><div>regards,</div><div>Asoka</div></div><div class=3D"=
gmail_extra"><br><div class=3D"gmail_quote">On Sun, Dec 10, 2017 at 5:37 PM=
, v <span dir=3D"ltr">&lt;<a href=3D"mailto:vso...@gmail.com" target=3D"_bl=
ank">vso...@gmail.com</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_q=
uote" style=3D"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1e=
x"><div dir=3D"ltr"><br><div class=3D"gmail_extra"><div class=3D"gmail_quot=
e"><span class=3D""><blockquote class=3D"gmail_quote" style=3D"margin:0px 0=
px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div =
dir=3D"ltr">Hi Vanessa,<div><br></div><div>I am trying to extend the contai=
ner for other users / use cases so I cannot modify .bashrc / profile or eve=
n manually enter it since I am considering making the startup of the contai=
ner to be transparent to the user. =C2=A0 The end result of this is to prov=
ide users with an ATLAS Tier3 environment. =C2=A0 I would like to avoid reb=
uilding it but as a very last resort can can ask if the container developer=
s can build future versions with =C2=A0%appenv.</div><div><br></div></div><=
/blockquote></span><div>ah understood. You can also bootstrap their contain=
er (use it as a base) and add your custom code to it, here are the docs:</d=
iv><div><br></div><div><a href=3D"http://singularity.lbl.gov/build-localima=
ge" target=3D"_blank">http://singularity.lbl.gov/<wbr>build-localimage</a><=
br></div><span class=3D""><div>=C2=A0<br></div><blockquote class=3D"gmail_q=
uote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,2=
04);padding-left:1ex"><div dir=3D"ltr"><div></div><div>(ATLAS_LOCAL_ROOT_BA=
SE should not be passed to the container unless the container does not defi=
ne it but this doe snot seem to be the issue as the sourcing will fail if i=
t does not exist.) =C2=A0If you have /cvmfs available , you can try it:</di=
v></div></blockquote><div><br></div></span><div>I don&#39;t have it, unfort=
unately :(=C2=A0</div><div><div class=3D"h5"><blockquote class=3D"gmail_quo=
te" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204=
);padding-left:1ex"><div dir=3D"ltr"><div><br></div><div><br></div><div>e.g=
.</div><div><br></div><div><div>[desilva@cdr818 ~]$ singularity shell =C2=
=A0-B /cvmfs/<a href=3D"http://atlas-condb.cern.ch" target=3D"_blank">atlas=
-condb.cern.ch</a>,/cv<wbr>mfs/<a href=3D"http://atlas-nightlies.cern.ch" t=
arget=3D"_blank">atlas-nightlies.cern.ch</a>,/<wbr>cvmfs/<a href=3D"http://=
atlas.cern.ch" target=3D"_blank">atlas.cern.ch</a>,/cvmfs/<a href=3D"http:/=
/sft.cern.ch" target=3D"_blank">sft<wbr>.cern.ch</a> /cvmfs/<a href=3D"http=
://atlas.cern.ch/repo/containers/images/singularity/x86_64-centos6.img" tar=
get=3D"_blank">atlas.cern.ch/repo/cont<wbr>ainers/images/singularity/x86_<w=
br>64-centos6.img</a> =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0=C2=A0</div>=
<div>Singularity: Invoking an interactive shell within container...</div><d=
iv><br></div><div>bash: warning: setlocale: LC_CTYPE: cannot change locale =
(en_US.UTF-8): No such file or directory</div><div>bash: warning: setlocale=
: LC_COLLATE: cannot change locale (en_US.UTF-8): No such file or directory=
</div><div>bash: warning: setlocale: LC_MESSAGES: cannot change locale (en_=
US.UTF-8): No such file or directory</div><div>bash: warning: setlocale: LC=
_NUMERIC: cannot change locale (en_US.UTF-8): No such file or directory</di=
v><div>bash: warning: setlocale: LC_TIME: cannot change locale (en_US.UTF-8=
): No such file or directory</div><div>Singularity.x86_64-centos6.img<wbr>&=
gt; exit</div><div>exit</div></div><div><br></div><div><br></div><div>notic=
e the prompt shows that you are in the bash env prior to exit.</div><div><b=
r></div><div><div>[desilva@cdr818 ~]$ singularity shell =C2=A0-B /cvmfs/<a =
href=3D"http://atlas-condb.cern.ch" target=3D"_blank">atlas-condb.cern.ch</=
a>,/cv<wbr>mfs/<a href=3D"http://atlas-nightlies.cern.ch" target=3D"_blank"=
>atlas-nightlies.cern.ch</a>,/<wbr>cvmfs/<a href=3D"http://atlas.cern.ch" t=
arget=3D"_blank">atlas.cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch" ta=
rget=3D"_blank">sft<wbr>.cern.ch</a> /cvmfs/<a href=3D"http://atlas.cern.ch=
/repo/containers/images/singularity/x86_64-centos6.img" target=3D"_blank">a=
tlas.cern.ch/repo/cont<wbr>ainers/images/singularity/x86_<wbr>64-centos6.im=
g</a> &lt; mySetup.sh</div><div>Singularity: Invoking an interactive shell =
within container...</div><div><br></div><div>lsetup =C2=A0 =C2=A0 =C2=A0 =
=C2=A0 =C2=A0 =C2=A0 =C2=A0 lsetup &lt;tool1&gt; [ &lt;tool2&gt; ...] (see =
lsetup -h):</div><div>=C2=A0lsetup agis =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0A=
TLAS Grid Information System</div><div>=C2=A0lsetup asetup =C2=A0 =C2=A0 =
=C2=A0 =C2=A0(or asetup) to setup an Athena release</div><div>=C2=A0lsetup =
atlantis =C2=A0 =C2=A0 =C2=A0Atlantis: event display</div><div>=C2=A0lsetup=
 eiclient =C2=A0 =C2=A0 =C2=A0Event Index=C2=A0</div><div>=C2=A0lsetup emi =
=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 EMI: grid middleware user interface=C2=
=A0</div><div>=C2=A0lsetup fax =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 Federated=
 XRootD data storage access (FAX)</div><div>=C2=A0lsetup ganga =C2=A0 =C2=
=A0 =C2=A0 =C2=A0 Ganga: job definition and management client</div><div>=C2=
=A0lsetup lcgenv =C2=A0 =C2=A0 =C2=A0 =C2=A0lcgenv: setup tools from cvmfs =
SFT repository</div><div>=C2=A0lsetup panda =C2=A0 =C2=A0 =C2=A0 =C2=A0 Pan=
da: Production ANd Distributed Analysis</div><div>=C2=A0lsetup pod =C2=A0 =
=C2=A0 =C2=A0 =C2=A0 =C2=A0 Proof-on-Demand (obsolete)</div><div>=C2=A0lset=
up pyami =C2=A0 =C2=A0 =C2=A0 =C2=A0 pyAMI: ATLAS Metadata Interface python=
 client</div><div>=C2=A0lsetup rcsetup =C2=A0 =C2=A0 =C2=A0 (or rcSetup) to=
 setup an ASG release</div><div>=C2=A0lsetup root =C2=A0 =C2=A0 =C2=A0 =C2=
=A0 =C2=A0ROOT data processing framework</div><div>=C2=A0lsetup rucio =C2=
=A0 =C2=A0 =C2=A0 =C2=A0 distributed data management system client</div><di=
v>=C2=A0lsetup sft =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 setup tools from SFT =
repo (use lcgenv instead)</div><div>=C2=A0lsetup xcache =C2=A0 =C2=A0 =C2=
=A0 =C2=A0XRootD local proxy cache</div><div>=C2=A0lsetup xrootd =C2=A0 =C2=
=A0 =C2=A0 =C2=A0XRootD data access</div><div>advancedTools =C2=A0 =C2=A0 =
=C2=A0 =C2=A0advanced tools menu</div><div>diagnostics =C2=A0 =C2=A0 =C2=A0=
 =C2=A0 =C2=A0diagnostic tools menu</div><div>helpMe =C2=A0 =C2=A0 =C2=A0 =
=C2=A0 =C2=A0 =C2=A0 =C2=A0 more help</div><div>printMenu =C2=A0 =C2=A0 =C2=
=A0 =C2=A0 =C2=A0 =C2=A0show this menu</div><div>showVersions =C2=A0 =C2=A0=
 =C2=A0 =C2=A0 show versions of installed software</div><div>[desilva@cdr81=
8 ~]$=C2=A0</div><div><br></div></div><div>and above it exits.</div><div><b=
r></div><div><br></div></div></blockquote></div></div><div>It sounds like t=
he script must exit and thus exit the shell. Just for clarity of informatio=
n: can you look at the runscript, and envrionment? eg:</div><div><br></div>=
<div><div><br></div></div></div></div><blockquote style=3D"margin:0 0 0 40p=
x;border:none;padding:0px"><div class=3D"gmail_extra"><div class=3D"gmail_q=
uote"><div><div>singularity inspect -e container.simg=C2=A0</div></div></di=
v></div><div class=3D"gmail_extra"><div class=3D"gmail_quote"><div><div>sin=
gularity inspect -r container.simg=C2=A0</div></div></div></div></blockquot=
e><div class=3D"gmail_extra"><div class=3D"gmail_quote"><div><br></div><div=
><div>What those scripts are looking at:</div><div><br></div></div></div></=
div><blockquote style=3D"margin:0 0 0 40px;border:none;padding:0px"><div cl=
ass=3D"gmail_extra"><div class=3D"gmail_quote"><div><div>singularity exec c=
ontainer.simg cat /.singularity.d/runscript</div></div></div></div><div cla=
ss=3D"gmail_extra"><div class=3D"gmail_quote"><div><div>#!/bin/sh</div></di=
v></div></div><div class=3D"gmail_extra"><div class=3D"gmail_quote"><div><d=
iv><br></div></div></div></div><div class=3D"gmail_extra"><div class=3D"gma=
il_quote"><div><div>exec &quot;/bin/bash&quot;</div></div></div></div><div =
class=3D"gmail_extra"><div class=3D"gmail_quote"><blockquote class=3D"gmail=
_quote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204=
,204);padding-left:1ex"><br>singularity exec container.simg cat /.singulari=
ty.d/env/90-<wbr>environment.sh</blockquote></div></div></blockquote><div c=
lass=3D"gmail_extra"><div class=3D"gmail_quote"><span class=3D""><div><br><=
/div><div><br></div><div>=C2=A0</div><blockquote class=3D"gmail_quote" styl=
e=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);paddin=
g-left:1ex"><div dir=3D"ltr"><div></div><div>In fact, make it a very simple=
 script that just does=C2=A0</div><div><div><br></div><div>[desilva@cedar5 =
~]$ cat -v hello.sh</div><div>echo &quot;hello&quot;</div><div><br></div><d=
iv><br></div><div>[desilva@cedar5 ~]$=C2=A0</div></div><div><br></div><div>=
<br></div><div><br></div><div><br></div><div>and it will do:</div><div><br>=
</div><div><div>[desilva@cdr818 ~]$ singularity shell =C2=A0-B /cvmfs/<a hr=
ef=3D"http://atlas-condb.cern.ch" target=3D"_blank">atlas-condb.cern.ch</a>=
,/cv<wbr>mfs/<a href=3D"http://atlas-nightlies.cern.ch" target=3D"_blank">a=
tlas-nightlies.cern.ch</a>,/<wbr>cvmfs/<a href=3D"http://atlas.cern.ch" tar=
get=3D"_blank">atlas.cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch" targ=
et=3D"_blank">sft<wbr>.cern.ch</a> /cvmfs/<a href=3D"http://atlas.cern.ch/r=
epo/containers/images/singularity/x86_64-centos6.img" target=3D"_blank">atl=
as.cern.ch/repo/cont<wbr>ainers/images/singularity/x86_<wbr>64-centos6.img<=
/a> &lt; ./hello.sh</div><div>Singularity: Invoking an interactive shell wi=
thin container...</div><div><br></div><div>hello</div><div>[desilva@cdr818 =
~]$=C2=A0</div></div><div><br></div><div><br></div><div>i.e. it exists.</di=
v><div><br></div></div></blockquote></span><div>Yeah that is wonky! I think=
 the best thing to do is start with walking through the pieces that are cal=
led. Since we don&#39;t have the recipe the inspection should be a good sta=
rt. I&#39;m going off to bed but likely others can pipe in, and I can help =
more tomorrow if needed.</div><div><br></div><div>Best,</div><div><br></div=
><div>Vanessa</div><div><div class=3D"h5"><div>=C2=A0</div><blockquote clas=
s=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid r=
gb(204,204,204);padding-left:1ex"><div dir=3D"ltr"><div></div><div>regards,=
</div><div>Asoka</div><div><br></div><div><br></div><div><br></div></div><d=
iv class=3D"m_1709178208493816230gmail-HOEnZb"><div class=3D"m_170917820849=
3816230gmail-h5"><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">=
On Sun, Dec 10, 2017 at 4:38 PM, v <span dir=3D"ltr">&lt;<a href=3D"mailto:=
vso...@gmail.com" target=3D"_blank">vso...@gmail.com</a>&gt;</span> wrote:<=
br><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;bord=
er-left:1px solid rgb(204,204,204);padding-left:1ex"><div dir=3D"ltr">Hey A=
soka,<div><br></div><div>If you are just using shell, is there any reason y=
ou can&#39;t source it after entering the container? You could also have so=
mething in a bashrc or profile that is used from your home, if you don&#39;=
t want to do that. We can definitely think of other ways - but arguably the=
 best (and more reproducible way) is to get the build recipe (that %environ=
ment section I was talking about is there) and modify it to be correct. Bec=
ause if someone finds your container and needs to do what you did, they wou=
ld have a hard time.</div><div><br></div><div>It could also be that the=C2=
=A0<span style=3D"font-size:12.8px">ATLAS_LOCAL_ROOT_BASE isn&#39;t being f=
ound so it&#39;s not sourcing at all, you can also pass it into the contain=
er like=C2=A0</span><span style=3D"font-size:12.8px">ATLAS_LOCAL_ROOT_BASE=
=3D/cv<wbr>mfs/</span><a href=3D"http://atlas.cern.ch/repo/ATLASLocalRootBa=
se" style=3D"font-size:12.8px" target=3D"_blank">atlas.cern.ch/repo/ATLASLo=
<wbr>calRootBase</a>=C2=A0singularity shell...</div><div><br></div><div>the=
 way you can test that the variable is getting in is to do something like:<=
/div><div><br></div><blockquote style=3D"margin:0px 0px 0px 40px;border:non=
e;padding:0px"><div>=C2=A0singularity exec container.simg env | grep ATLAS_=
LOCAL_ROOT_BASE</div></blockquote><div><br></div><div>and then do the same =
for the script, maybe use cat to look at it.</div><div><br></div><blockquot=
e style=3D"margin:0px 0px 0px 40px;border:none;padding:0px"><div><div>=C2=
=A0singularity exec container.simg cat=C2=A0<span style=3D"font-size:12.8px=
">${ATLAS_LOCAL_ROOT_BASE}/u<wbr>ser/</span><span style=3D"font-size:12.8px=
">atlasLocalSetup.sh</span></div></div></blockquote><div><span style=3D"fon=
t-size:12.8px"><br></span></div><div>I&#39;m also wondering why the contain=
er is exiting if you are shelling. It would be logical for it to exit on ex=
ec or run, but probably not shell. If there is a source that runs cleanly i=
t should not technically exit. I would check 1) if there is any exit logic =
in the source and 2) that you aren&#39;t still actually in the container.</=
div><div><br></div><div>Best,</div><div><br></div><div>Vanessa</div></div><=
div class=3D"m_1709178208493816230gmail-m_8902286953652767761HOEnZb"><div c=
lass=3D"m_1709178208493816230gmail-m_8902286953652767761h5"><div class=3D"g=
mail_extra"><br><div class=3D"gmail_quote">On Sun, Dec 10, 2017 at 4:27 PM,=
 Asoka De Silva <span dir=3D"ltr">&lt;<a href=3D"mailto:asoka....@computeca=
nada.ca" target=3D"_blank">asoka.desilva@computecanada.c<wbr>a</a>&gt;</spa=
n> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px =
0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div dir=3D"=
ltr">Hi Vanessa,<div><br></div><div>Thanks for the super fast reply !</div>=
<div><br></div><div>This is a pre-built image and all I can do is to run it=
.=C2=A0 Sorry for the naive question (new at this) but how do I add to the =
%environment or %appenv section or is there a way to override ?</div><div><=
br></div><div>Thanks !</div><div><br></div><div>regards,</div><div>Asoka</d=
iv></div><div class=3D"m_1709178208493816230gmail-m_8902286953652767761m_84=
90207232984931379HOEnZb"><div class=3D"m_1709178208493816230gmail-m_8902286=
953652767761m_8490207232984931379h5"><div class=3D"gmail_extra"><br><div cl=
ass=3D"gmail_quote">On Sun, Dec 10, 2017 at 4:18 PM, v <span dir=3D"ltr">&l=
t;<a href=3D"mailto:vso...@gmail.com" target=3D"_blank">vso...@gmail.com</a=
>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin:0p=
x 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><d=
iv dir=3D"ltr">Hey Asoka,<div><br></div><div>Have you tried including your =
source lines in the %environment section? That will be sourced when you she=
ll / run etc. the container. If you need it to only be specific to some con=
text (and not source for any shell at all) then you could use a <a href=3D"=
http://containers-ftw.org/SCI-F/" target=3D"_blank">SCI-F app</a> to do it,=
 eg:</div><div><br></div><blockquote style=3D"margin:0px 0px 0px 40px;borde=
r:none;padding:0px"><div>%appenv mycontext</div><div><br></div><div>(write =
code here)</div></blockquote><div><br></div><div>and then when you run/shel=
l</div><div><br></div><div>=C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0 =C2=A0# will =
source the environment above</div><blockquote style=3D"margin:0px 0px 0px 4=
0px;border:none;padding:0px"><div>singularity run --app mycontext container=
.simg</div></blockquote><div><br></div><div><div>=C2=A0 =C2=A0 =C2=A0 =C2=
=A0 =C2=A0 =C2=A0# will not</div><blockquote style=3D"margin:0px 0px 0px 40=
px;border:none;padding:0px">singularity run container.simg</blockquote></di=
v><div><br></div><div>Best,</div><div><br></div><div>Vanessa</div></div><di=
v class=3D"gmail_extra"><div><div class=3D"m_1709178208493816230gmail-m_890=
2286953652767761m_8490207232984931379m_8404218610920459009h5"><br><div clas=
s=3D"gmail_quote">On Sun, Dec 10, 2017 at 4:13 PM, Asoka De Silva <span dir=
=3D"ltr">&lt;<a href=3D"mailto:asoka....@computecanada.ca" target=3D"_blank=
">asoka.desilva@computecanada.c<wbr>a</a>&gt;</span> wrote:<br><blockquote =
class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px sol=
id rgb(204,204,204);padding-left:1ex"><div dir=3D"ltr"><div>Hi,</div><div><=
br></div><div>$ singularity --version</div><div>2.3.1-dist</div><div><br></=
div><div><br></div><div>singularity shell =C2=A0-B /cvmfs/<a href=3D"http:/=
/atlas-condb.cern.ch" target=3D"_blank">atlas-condb.cern.ch</a>,/cv<wbr>mfs=
/<a href=3D"http://atlas-nightlies.cern.ch" target=3D"_blank">atlas-nightli=
es.cern.ch</a>,/c<wbr>vmfs/<a href=3D"http://atlas.cern.ch" target=3D"_blan=
k">atlas.cern.ch</a>,/cvmfs/<a href=3D"http://sft.cern.ch" target=3D"_blank=
">sft.<wbr>cern.ch</a> /cvmfs/<a href=3D"http://atlas.cern.ch/repo/containe=
rs/images/singularity/x86_64-centos6.img" target=3D"_blank">atlas.cern.ch/r=
epo/cont<wbr>ainers/images/singularity/x86_<wbr>64-centos6.img</a></div><di=
v><br></div><div>will result in an interactive bash shell of a singularity =
container.=C2=A0 What I would like to do is to source a script automaticall=
y - e.g. do these lines, and then continue with the interactive shell:</div=
><div><br></div><div>cat mySetup.sh</div><div><br></div><div>if [ -z $ATLAS=
_LOCAL_ROOT_BASE ]; then</div><div>=C2=A0 export ATLAS_LOCAL_ROOT_BASE=3D/c=
vmfs/<a href=3D"http://atlas.cern.ch/repo/ATLASLocalRootBase" target=3D"_bl=
ank">a<wbr>tlas.cern.ch/repo/ATLASLocalRo<wbr>otBase</a></div><div>fi</div>=
<div>source ${ATLAS_LOCAL_ROOT_BASE}/user/<wbr>atlasLocalSetup.sh</div><div=
><br></div><div><br></div><div><br></div><div>Is there a way to do this and=
 continue with the interactive bash shell env ?=C2=A0 I tried=C2=A0</div><d=
iv><br></div><div>echo &quot;source mySetup.sh&quot; | singularity shell -B=
 /cvmfs/<a href=3D"http://atlas-condb.cern.ch" target=3D"_blank">atlas-cond=
b.cern.ch</a>,/cv<wbr>mfs/<a href=3D"http://atlas-nightlies.cern.ch" target=
=3D"_blank">atlas-nightlies.cern.ch</a>,/c<wbr>vmfs/<a href=3D"http://atlas=
.cern.ch" target=3D"_blank">atlas.cern.ch</a>,/cvmfs/<a href=3D"http://sft.=
cern.ch" target=3D"_blank">sft.<wbr>cern.ch</a> /cvmfs/<a href=3D"http://at=
las.cern.ch/repo/containers/images/singularity/x86_64-centos6.img" target=
=3D"_blank">atlas.cern.ch/repo/cont<wbr>ainers/images/singularity/x86_<wbr>=
64-centos6.img</a></div><div><br></div><div>and also</div><div><br></div><d=
iv>singularity shell -B /cvmfs/<a href=3D"http://atlas-condb.cern.ch" targe=
t=3D"_blank">atlas-condb.cern.ch</a>,/cv<wbr>mfs/<a href=3D"http://atlas-ni=
ghtlies.cern.ch" target=3D"_blank">atlas-nightlies.cern.ch</a>,/c<wbr>vmfs/=
<a href=3D"http://atlas.cern.ch" target=3D"_blank">atlas.cern.ch</a>,/cvmfs=
/<a href=3D"http://sft.cern.ch" target=3D"_blank">sft.<wbr>cern.ch</a> /cvm=
fs/<a href=3D"http://atlas.cern.ch/repo/containers/images/singularity/x86_6=
4-centos6.img" target=3D"_blank">atlas.cern.ch/repo/cont<wbr>ainers/images/=
singularity/x86_<wbr>64-centos6.img</a> &lt; mySetup.sh<br></div><div><br><=
/div><div>but it sources mySetup.sh script and then exits the container.</d=
iv><div><br></div><div><br></div><div>(The container images are not user mo=
difiable.)</div><div><br></div><div><br></div><div>Thanks in advance for an=
y help !</div><div><br></div><div>regards,</div><div>Asoka</div></div><span=
 class=3D"m_1709178208493816230gmail-m_8902286953652767761m_849020723298493=
1379m_8404218610920459009m_-41778606393869326HOEnZb"><font color=3D"#888888=
">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</font></span></blockquote></div><br><br clear=3D"all"><div><br></div></div=
></div><span class=3D"m_1709178208493816230gmail-m_8902286953652767761m_849=
0207232984931379m_8404218610920459009HOEnZb"><font color=3D"#888888">-- <br=
><div class=3D"m_1709178208493816230gmail-m_8902286953652767761m_8490207232=
984931379m_8404218610920459009m_-41778606393869326gmail_signature">Vanessa =
Villamia Sochat<br>Stanford University &#39;16<br><div><div><div><a href=3D=
"tel:(603)%20321-0676" value=3D"+16033210676" target=3D"_blank">(603) 321-0=
676</a></div></div></div></div>
</font></span></div><div class=3D"m_1709178208493816230gmail-m_890228695365=
2767761m_8490207232984931379m_8404218610920459009HOEnZb"><div class=3D"m_17=
09178208493816230gmail-m_8902286953652767761m_8490207232984931379m_84042186=
10920459009h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
<div class=3D"m_1709178208493816230gmail-m_8902286953652767761m_84902072329=
84931379gmail_signature">Vanessa Villamia Sochat<br>Stanford University &#3=
9;16<br><div><div><div><a href=3D"tel:(603)%20321-0676" value=3D"+160332106=
76" target=3D"_blank">(603) 321-0676</a></div></div></div></div>
</div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br></div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div></div></div><div><div class=3D"h5"><br><br c=
lear=3D"all"><div><br></div>-- <br><div class=3D"m_1709178208493816230gmail=
_signature" data-smartmail=3D"gmail_signature">Vanessa Villamia Sochat<br>S=
tanford University &#39;16<br><div><div><div><a href=3D"tel:(603)%20321-067=
6" value=3D"+16033210676" target=3D"_blank">(603) 321-0676</a></div></div><=
/div></div>
</div></div></div></div><div class=3D"HOEnZb"><div class=3D"h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.<wbr>gov</a>.<br>
</div></div></blockquote></div><br></div>

--001a113d0c78a1b7d7056006f48d--
