X-Received: by 10.98.160.77 with SMTP id r74mr10946398pfe.37.1511726999842;
        Sun, 26 Nov 2017 12:09:59 -0800 (PST)
X-BeenThere: singularity@lbl.gov
Received: by 10.99.124.83 with SMTP id l19ls3195331pgn.26.gmail; Sun, 26 Nov
 2017 12:09:58 -0800 (PST)
X-Received: by 10.98.67.150 with SMTP id l22mr987530pfi.32.1511726998721;
        Sun, 26 Nov 2017 12:09:58 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1511726998; cv=none;
        d=google.com; s=arc-20160816;
        b=URHu5//NJ89+5679g7c9V7dZikrdWSE4kSlH/8TSrFrB9ElUOAZ8poJHhQZZ9sPsIU
         c2PB9Uppfg8SsBK8CTW5OpEEgyWFIdAvF8IUqxQte3wt4KVXy5I/KzwqO0FOrj1az064
         fOmTIvii/nN+XoR7FeDPmE3s18bTzew9qauVE19Gu76+BmSDy5EmXK1Tx1l0OgThpval
         +9Mdr2ozsm9oKcYvpmNBxQqygndJThnolcMJKOeNRNgpXwEOlEdL+I8bimk2SYkg6G9l
         0ASvqZS1oOTUUcuOtbIkroXpEyvpjJ65J2FflnV2d0mEPrK9yc9L8Gvssapo77fPH6Vs
         9kRg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=to:subject:message-id:date:from:references:in-reply-to:mime-version
         :dkim-signature:arc-authentication-results;
        bh=bjHxDiQJOX6BFx/7YU28ScAOP7zdSJiiIWNF9dmJdPg=;
        b=bYojOjtKTkj7N/PxupwygTSAzwypBmRJFCX6jAuIMIQmqGO0XzgLXITgfqxaA4wcLR
         hZ2rGw6cRsby4k1wJLMdBcjjI3WPc2VNLEnzdPns7ygV5xmbytHwAXS+/YXpGSNBaCX5
         jJdujUQvIfmm4tloq9ZD7DhjukDFWlAlux7egZ4e24nhZ5UYeq6bPnP8LFCsmEtzftp8
         1yQOxbGRaQRKDhVL5XGjSpik9vAEqaFvoi1Hxuq2GcEeF1F0rAYPlxHN7ubAgWaUBt3T
         TCwZwMUshHUrKrGdXC/4z+5gLen9lOmYllt20ehcH1MltQ6mWw2qqus9Fvql+zJMx724
         pEQA==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass head...@gmail.com header.s=20161025 header.b=qddrihEi;
       spf=pass (google.com: domain of vso...@gmail.com designates 74.125.82.170 as permitted sender) smtp.mailfrom=vso...@gmail.com
Return-Path: <vso...@gmail.com>
Received: from fe3.lbl.gov (fe3.lbl.gov. [128.3.41.68])
        by mx.google.com with ESMTP id h74si23828630pfe.172.2017.11.26.12.09.58
        for <singu...@lbl.gov>;
        Sun, 26 Nov 2017 12:09:58 -0800 (PST)
Received-SPF: pass (google.com: domain of vso...@gmail.com designates 74.125.82.170 as permitted sender) client-ip=74.125.82.170;
Authentication-Results: mx.google.com;
       dkim=pass head...@gmail.com header.s=20161025 header.b=qddrihEi;
       spf=pass (google.com: domain of vso...@gmail.com designates 74.125.82.170 as permitted sender) smtp.mailfrom=vso...@gmail.com
X-Ironport-SBRS: 3.4
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A2FDAQAnHxtahqpSfUpXAx4BBgyDDgKBE?=
 =?us-ascii?q?m4nB4NwCIEEMpd/gX2CVx6RKIJggT4bJQMiAQyBCYIvgQ9PAoRXB0MUAQEBAQE?=
 =?us-ascii?q?BAQEBAQIQAQEBCAsLCCgvgjgFAgMaBgUESCYDAwEBAQEBAQEBASIBAQEBAQEBA?=
 =?us-ascii?q?QEBAQEBAQEBAQEYAg0XBwQhARkBAQEBAgEaCQQZAQ0OEQ0DAQsGBQsHBiABCQI?=
 =?us-ascii?q?CIQEBDgMBBQEODg4HBAEIEgIEh2hJgTcBAw0IBQuZYUCMEIFtGAUBHIMKBYNXC?=
 =?us-ascii?q?hknDViCZwEBAQcBAQEBAQEBAQEXAgYSgRCCGIIHhVsYdoJrR4EuCQESAQk3DBq?=
 =?us-ascii?q?CTheCTAWTCoYciGM9h3KDaoQ3hHmCFmKFKossijeCPzuFGAGDXBkfgRY2Vi5vb?=
 =?us-ascii?q?xU5MoFnAQ8JghAqH4IUIDYBAQEBBId/SIFwAQEB?=
X-IronPort-AV: E=Sophos;i="5.44,460,1505804400"; 
   d="scan'208,217";a="97717123"
Received: from mail-ot0-f170.google.com ([74.125.82.170])
  by fe3.lbl.gov with ESMTP; 26 Nov 2017 12:09:48 -0800
Received: by mail-ot0-f170.google.com with SMTP id 18so22544158oty.9
        for <singu...@lbl.gov>; Sun, 26 Nov 2017 12:09:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:in-reply-to:references:from:date:message-id:subject:to;
        bh=bjHxDiQJOX6BFx/7YU28ScAOP7zdSJiiIWNF9dmJdPg=;
        b=qddrihEi9la7Qvhh07WGXuHTLZpKwzNlRg3TIglIHKfPYcYuFfF0biihspY+0ovA93
         rC+4K4BKG7OPefkG+u/QGHMBSDENnsDBQ5Lyrb2DhCM+8uKPYWfxKQZezbOzKMmyQBO8
         +EuUQ+uEee1EXpIvFqZU4gjoeK/eZ9cvbrCg1v4GLD46s5LH1GZ4mTAktZpScv14KIo1
         V0KUiknc5+hUK+SX+80l6NkPeYJbf0QyuArlgO2reTPb6Zho9qbERTViklC/r0c4StBQ
         LiecO3Ox2ZuAMC8piU54uJf7L0UCan1fBW/q3raUTmYDTm+AeXS/lDcyBW7DIcnq7V4u
         YJYg==
X-Gm-Message-State: AJaThX5RSDcIRaZ7/4/LpnE8+PHYGnDHUvayDbGMs6cDv2CD0a0CqRAk
	392LVn20q+y+Ge2GLKdKnSQ6ztPubo4hgfNqI3HNuRBT
X-Received: by 10.157.38.66 with SMTP id a60mr24389109otb.112.1511726987351;
 Sun, 26 Nov 2017 12:09:47 -0800 (PST)
MIME-Version: 1.0
Received: by 10.74.165.72 with HTTP; Sun, 26 Nov 2017 12:09:26 -0800 (PST)
In-Reply-To: <CAMG2UCCvFYhOu7CYxgZ6SXFQvgKBSVTmeD72EpPYAEXTwxB3ew@mail.gmail.com>
References: <cecdf0cf-7c70-4ff6-bb41-d5523587a550@lbl.gov> <CAM=pu+J9otnhcnP3knQ4L22nfLvCGkU6pLZejFhZE2fTi_QhDw@mail.gmail.com>
 <CAMG2UCB4f4=gG0D6rESr67dDhZaDquEeR718=2JPck+eTOR8qw@mail.gmail.com>
 <CAM=pu+KWN3F0DydrYY1h1+vmS67afT9Y3TLeWyDUwRFfWJbpww@mail.gmail.com>
 <CAMG2UCCYWB+kzBjr7O6A1Bjm8jawyjGFmWWr3QRVT=qUs2YX5w@mail.gmail.com>
 <CAM=pu++FqTxTMJ4EmN7m4S3=3+eyVVmrV0r3dQVxEEZTAPNLGg@mail.gmail.com>
 <CAMG2UCAD1M4PiAef2tmvt2YzG7_8LTih=RFQ5waRjU36oaKRJQ@mail.gmail.com>
 <CAM=pu+J6SXK31HqK9gr7A_Np2U5JZgv86Orr87H6g01tUmKBCg@mail.gmail.com> <CAMG2UCCvFYhOu7CYxgZ6SXFQvgKBSVTmeD72EpPYAEXTwxB3ew@mail.gmail.com>
From: v <vso...@gmail.com>
Date: Sun, 26 Nov 2017 12:09:26 -0800
Message-ID: <CAM=pu+KPSzdtiobvvwCNNs0yURgLH+7vrxJE-W6tNH91pXv=ug@mail.gmail.com>
Subject: Re: [Singularity] Celery RabbitMQ worker packaged in a Singularity container
To: singularity@lbl.gov
Content-Type: multipart/alternative; boundary="94eb2c04d376141da3055ee85ebf"

--94eb2c04d376141da3055ee85ebf
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

On Sun, Nov 26, 2017 at 11:16 AM, Dejan =C5=A0tepec <stepec...@gmail.com>
wrote:

> Thanks for your inputs. So there is no way to get "internet access" insid=
e
> Singularity container to access remote Queue which makes it quite unusabl=
e
> for our task.
>

No you definitely can! The container itself is pretty seamless to the host.
I think what would make it unusable is requiring a (separate) container
only network space, but I can imagine ways to do it not needing that.


> We don't have time/resources to develop the Singularity :(.
>

Haha, tell me about it :)  This is how open source works.

Another problem is that the nodes would have to be running constantly and
> listening for new jobs in a queue. Continuously restarting the node for
> each request would be inefficient as we are using deep learning models th=
at
> are heavy by their design and loading the architecture again and again on
> the GPU would be time consuming. Docker + Kubernetes is ideal but we only
> have access to multiple GPUs on some HPC cluster currently.
>

I can think of ways how I'd do it, but I can't give you a full instruction
manual / tutorial, which sounds like it's what you are looking for. I think
probably this will eventually exist but it's not done yet.

Best of luck! Please share anyway if you do something cool, I (and other
users on the list) are highly interested.


>
> Best,
>
> Dejan
>
> 2017-11-26 18:25 GMT+01:00 v <vso...@gmail.com>:
>
>> As far as I know not yet, it would need to be possible to define
>> networking between containers like Docker does -->
>> https://docs.docker.com/engine/userguide/networking/ and then have an
>> orchestrator to map between host and other containers. What you could tr=
y
>> is starting container instances that use a (shared) network (localhost) =
and
>> maybe have them operate at different ports?
>>
>> Just curious - what is your strategy for the layer between the web
>> application and the GPU servers? These kind of connections (to a shared
>> resource with sensitive data and what not) historically can make some
>> nervous :P
>>
>> I think what you are saying is:
>>
>>  1. user requests task on front end
>>  2. front end handles authentication and authorization
>>  3. front end submits job to celery
>>  4. celery task is a Singularity container running on GPU, and since
>> worker =3D=3D container, it requires networking
>>
>> and what I'm suggesting is to separate the front / back servers a bit
>> more:
>>
>>  1. user requests task on front end
>>  2. front end handles authentication and authorization
>>  3. front end submits job to celery (still frontend)
>>  4. celery worker(still frontend) is a process that finishes
>> configuration of job (memory? time? cluster? queue type?) and sends job =
to
>> a back end queue (slurm, sge)
>>  5. the slurm/sge queues are optimized for this sort of thing, so you
>> just load the singularity module, run the job, and send a signal back to
>> the front end queue.
>>
>> So a few notes on the above:
>>  - there is flexibility (step 4) to have different kinds of queues in
>> different locations. The front end worker is the manager of where things=
 go.
>>  - the singularity container is not required to have a network, or be
>> constantly running.
>>  - the main server (the same celery workers) also need a means to receiv=
e
>> messages of something finishing to update the server, this could be a PO=
ST
>> or similar.
>>  - ideally you could manage slurm or sge with an API.
>>
>> I think there are two general recipes you can follow here. If you go the
>> "old school HPC route" then you would do something like the above. You
>> don't have a container cluster, you have standard job managers and tools
>> that communicate to them.  If you go the "container cluster" route then
>> what would be needed is to have orchestration defined for Singularity, a=
nd
>> even better integration with Kubernetes. Several have talked about this =
but
>> I don't see any code yet :) It's a bit of a catch 22, because you could
>> just use Docker for the second, but wait you can't because Docker + HPC =
=3D
>> death. You could just use HPC technology for the first but wait you can'=
t,
>> because that's not going to plug in easily in environments outside of HP=
C.
>> So your choices are to help make Singularity more enterprise/cloudy to
>> integrate into container clusters, or to imagine if a more HPC-centric
>> method could be adopted in different environments. I think generally
>> connecting protected clusters to the outside world is a hard problem, ta=
ke
>> a look at Agave --> https://github.com/agaveapi for inspiration.
>>
>> Best,
>>
>> Vanessa
>>
>>
>>
>>
>> On Sun, Nov 26, 2017 at 8:48 AM, Dejan =C5=A0tepec <stepec...@gmail.com>
>> wrote:
>>
>>> Frontend server probably using Flask yes will authenticate the user
>>> using calls to existing backend so this part is taken care of. After
>>> sucessfull authentication I would like to send task to the task queue
>>> (celery) and one of the predefinied and started gpu workers that would =
run
>>> on separate nodes using Singularity would take the job, execute it and =
send
>>> the results back to the frontend server which would deliver result back=
 to
>>> the backend. So my only concern was if networking in Singularity suppor=
ts
>>> this kind of idea ( running container as a Celery worker - tcp connecti=
on
>>> to some remote queue, that maybe will also run as a Singularity contain=
er).
>>> Basically is this possible?
>>>
>>> 26. nov. 2017 4:32 pop. je oseba "v" <vso...@gmail.com> napisala:
>>>
>>> oh that is super cool! If the celery workers are part of the web
>>>> service, this is a reasonable approach I think. I would use a standard
>>>> (front server) set up with some application (e.g., django or flask dri=
ven
>>>> if you are using Python) controlling / set up with a queue, and instea=
d of
>>>> having the job queue living with the frontend server part, I would hav=
e one
>>>> async task that has the job to assess metadata (eg, is this a user of
>>>> cluster X? how much memory and time does it need?) to send it to your
>>>> infrastructure queue (a different queue!) to first pass through
>>>> authentication, authorization, etc. Actually, you could probably also =
do
>>>> this with an internal API. I've never tried, but it seems like it woul=
d be
>>>> challenging to require the celery connected to the web application to
>>>> actually control the nodes. If you get in some situation of wanting to=
 add
>>>> another set of (kind of different or external nodes) it would be hard =
to
>>>> do. If each is sort of modular (meaning the celery workers have an
>>>> authenticated general message they can send anywhere, to multiple kind=
s of
>>>> nodes) that seems like a good approach.
>>>>
>>>> On Sun, Nov 26, 2017 at 7:26 AM, Dejan =C5=A0tepec <stepec...@gmail.co=
m
>>>> > wrote:
>>>>
>>>>> The whole thing will be part of a bigger web service so this
>>>>> additional image processing service will get requests from some backe=
nd
>>>>> infrastructure and this service besides compute nodes will consist al=
so
>>>>> from a server (master) that will accept remote requests (e.g. web soc=
kets)
>>>>> and will be pushing work to a queue to Celery workers. Probably Celer=
y is
>>>>> not absolutely needed but we want the service to be portable not used=
 only
>>>>> on HPCs but some other cluster using e.g. Kubernetes and Docker etc.
>>>>>
>>>>> 26. nov. 2017 4:17 pop. je oseba "v" <vso...@gmail.com> napisala:
>>>>>
>>>>> If management of resources (nodes) is in order, I think a proper job
>>>>>> manager might be better fit for this job. Celery (from how I've used=
 it) is
>>>>>> more appropriate for a situation like a web application where you wa=
nt the
>>>>>> server to have a job queue, and put tasks in it to run when there is=
 free
>>>>>> compute time (and to run async). They are similar because a "master"=
 node
>>>>>> maps to the broker, and the "slaves" map to the workers. Also in my
>>>>>> experience the workers are on and ready, which would translate to ha=
ving
>>>>>> multiple container instances running and listening for tasks. Is the=
re a
>>>>>> reason you have preference for celery instead of traditional SLURM /=
 SGE /
>>>>>> other? I think if you really wanted to do this fully it would be mos=
t
>>>>>> logical to add an actual supporting plugin for singularity workers t=
o
>>>>>> rabbitmq:
>>>>>>
>>>>>> https://pubs.vmware.com/vfabric5/index.jsp#com.vmware.vfabri
>>>>>> c.rabbitmq.2.4/plugin-development.html
>>>>>>
>>>>>> Or something similar with celery. Keep us in the loop!
>>>>>>
>>>>>> On Sun, Nov 26, 2017 at 12:50 AM, Dejan =C5=A0tepec <
>>>>>> stepec...@gmail.com> wrote:
>>>>>>
>>>>>>> I intented to use multiple instances of separete nodes because of
>>>>>>> heavy use of GPUs. I guess that for such usage there would be bette=
r to
>>>>>>> make workers completely independent as separate instances of contai=
ners.
>>>>>>> The only thing that I wasn't sure of is the networking part in Sing=
ularity,
>>>>>>> meaning if we can connect to a remote queue to get a job.
>>>>>>>
>>>>>>> 26. nov. 2017 3:07 dop. je oseba "v" <vso...@gmail.com> napisala:
>>>>>>>
>>>>>>> This is a cool use case!
>>>>>>>>
>>>>>>>> So I'm guessing the image processing app is probably in python? An=
d
>>>>>>>> you have python tasks defined for it? The broker is a remote queue
>>>>>>>> (RabbitMQ) that would utilize the workers.
>>>>>>>>
>>>>>>>> Is there a reason to have multiple instances for many workers? I'v=
e
>>>>>>>> tried both, and usually the solution I prefer is to start a single
>>>>>>>> container with concurrency (meaning multiple workers). By default =
the call
>>>>>>>> to start the worker with celery will do the number of cores availa=
ble, but
>>>>>>>> you can also set it to be something different (eg celery -A myproj=
ect
>>>>>>>> worker --concurrency=3D10...). For Singularity you would want to h=
ave your
>>>>>>>> image, and then have a startscript for it, and have the startscrip=
t be this
>>>>>>>> celery command to start up the (concurrent) workers.
>>>>>>>>
>>>>>>>> I would start out doing the following:
>>>>>>>>
>>>>>>>>  - create a singularity image that has a startscript with your
>>>>>>>> command to start the workers
>>>>>>>>  - start an instance
>>>>>>>>  - set up your RabbitMQ and test sending jobs to it.
>>>>>>>>  - report back!
>>>>>>>>
>>>>>>>> Best,
>>>>>>>>
>>>>>>>> Vanessa
>>>>>>>>
>>>>>>>> On Sat, Nov 25, 2017 at 5:10 PM, Dejan =C5=A0tepec <
>>>>>>>> stepec...@gmail.com> wrote:
>>>>>>>>
>>>>>>>>> Hi all!
>>>>>>>>>
>>>>>>>>> As a new user of a Singularity I have a question about a use case=
.
>>>>>>>>> I intend to package an image processing app in a Singularity cont=
ainer but
>>>>>>>>> have a question about communication between separate nodes for ex=
ample
>>>>>>>>> using RabitMQ or to access to some remote queue. I intend to pack=
age these
>>>>>>>>> worker nodes as a Celery <http://www.celeryproject.org/> workers
>>>>>>>>> so I need to know if we can connect to a remote RabbitMQ queue fr=
om the
>>>>>>>>> Singularity container to get a new batch of data to be processed =
from a
>>>>>>>>> remote queue. I intend to use Singularity as this nodes are compu=
tationally
>>>>>>>>> intensive and will be placed at some HPC with SLURM workload mana=
ger
>>>>>>>>> installed of course having no sudo access.
>>>>>>>>>
>>>>>>>>> Best regards,
>>>>>>>>>
>>>>>>>>> Dejan
>>>>>>>>>
>>>>>>>>> --
>>>>>>>>> You received this message because you are subscribed to the Googl=
e
>>>>>>>>> Groups "singularity" group.
>>>>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>>>>> send an email to singu...@lbl.gov.
>>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> --
>>>>>>>> Vanessa Villamia Sochat
>>>>>>>> Stanford University '16
>>>>>>>> (603) 321-0676
>>>>>>>>
>>>>>>>> --
>>>>>>>> You received this message because you are subscribed to the Google
>>>>>>>> Groups "singularity" group.
>>>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>>>> send an email to singu...@lbl.gov.
>>>>>>>>
>>>>>>> --
>>>>>>> You received this message because you are subscribed to the Google
>>>>>>> Groups "singularity" group.
>>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>>> send an email to singu...@lbl.gov.
>>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Vanessa Villamia Sochat
>>>>>> Stanford University '16
>>>>>> (603) 321-0676
>>>>>>
>>>>>> --
>>>>>> You received this message because you are subscribed to the Google
>>>>>> Groups "singularity" group.
>>>>>> To unsubscribe from this group and stop receiving emails from it,
>>>>>> send an email to singu...@lbl.gov.
>>>>>>
>>>>> --
>>>>> You received this message because you are subscribed to the Google
>>>>> Groups "singularity" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, sen=
d
>>>>> an email to singu...@lbl.gov.
>>>>>
>>>>
>>>>
>>>>
>>>> --
>>>> Vanessa Villamia Sochat
>>>> Stanford University '16
>>>> (603) 321-0676
>>>>
>>>> --
>>>> You received this message because you are subscribed to the Google
>>>> Groups "singularity" group.
>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>> an email to singu...@lbl.gov.
>>>>
>>> --
>>> You received this message because you are subscribed to the Google
>>> Groups "singularity" group.
>>> To unsubscribe from this group and stop receiving emails from it, send
>>> an email to singu...@lbl.gov.
>>>
>>
>>
>>
>> --
>> Vanessa Villamia Sochat
>> Stanford University '16
>> (603) 321-0676
>>
>> --
>> You received this message because you are subscribed to the Google Group=
s
>> "singularity" group.
>> To unsubscribe from this group and stop receiving emails from it, send a=
n
>> email to singu...@lbl.gov.
>>
>
>
>
> --
>
> <stepec...@gmail.com> *stepec...@gmail.com
> <stepec...@gmail.com>*
>
> <dejan...@live.com>
> *dejan...@live.com <dejan...@live.com> dejanstepec*
>
> --
> You received this message because you are subscribed to the Google Groups
> "singularity" group.
> To unsubscribe from this group and stop receiving emails from it, send an
> email to singu...@lbl.gov.
>



--=20
Vanessa Villamia Sochat
Stanford University '16
(603) 321-0676

--94eb2c04d376141da3055ee85ebf
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr"><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">=
On Sun, Nov 26, 2017 at 11:16 AM, Dejan =C5=A0tepec <span dir=3D"ltr">&lt;<=
a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">stepec...@gmail.com=
</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin=
:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"=
><div dir=3D"ltr">Thanks for your inputs. So there is no way to get &quot;i=
nternet access&quot; inside Singularity container to access remote Queue wh=
ich makes it quite unusable for our task. </div></blockquote><div><br></div=
><div>No you definitely can! The container itself is pretty seamless to the=
 host. I think what would make it unusable is requiring a (separate) contai=
ner only network space, but I can imagine ways to do it not needing that.</=
div><div>=C2=A0</div><blockquote class=3D"gmail_quote" style=3D"margin:0px =
0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div=
 dir=3D"ltr">We don&#39;t have time/resources to develop the Singularity :(=
.</div></blockquote><div><br></div><div>Haha, tell me about it :)=C2=A0 Thi=
s is how open source works.</div><div><br></div><blockquote class=3D"gmail_=
quote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,=
204);padding-left:1ex"><div dir=3D"ltr"><div>Another problem is that the no=
des would have to be running constantly and listening for new jobs in a que=
ue. Continuously restarting the node for each request would be inefficient =
as we are using deep learning models that are heavy by their design and loa=
ding the architecture again and again on the GPU would be time consuming. D=
ocker + Kubernetes is ideal but we only have access to multiple GPUs on som=
e HPC cluster currently.</div></div></blockquote><div><br></div><div>I can =
think of ways how I&#39;d do it, but I can&#39;t give you a full instructio=
n manual / tutorial, which sounds like it&#39;s what you are looking for. I=
 think probably this will eventually exist but it&#39;s not done yet.</div>=
<div><br></div><div>Best of luck! Please share anyway if you do something c=
ool, I (and other users on the list) are highly interested.</div><div>=C2=
=A0</div><blockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8e=
x;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div dir=3D"ltr"=
><div><br></div><div>Best,</div><div><br></div><div>Dejan</div></div><div c=
lass=3D"gmail_extra"><div><div class=3D"gmail-h5"><br><div class=3D"gmail_q=
uote">2017-11-26 18:25 GMT+01:00 v <span dir=3D"ltr">&lt;<a href=3D"mailto:=
vso...@gmail.com" target=3D"_blank">vso...@gmail.com</a>&gt;</span>:<br><bl=
ockquote class=3D"gmail_quote" style=3D"margin:0px 0px 0px 0.8ex;border-lef=
t:1px solid rgb(204,204,204);padding-left:1ex"><div dir=3D"ltr">As far as I=
 know not yet, it would need to be possible to define networking between co=
ntainers like Docker does --&gt;=C2=A0<a href=3D"https://docs.docker.com/en=
gine/userguide/networking/" target=3D"_blank">https://docs.docker.com/en<wb=
r>gine/userguide/networking/</a> and then have an orchestrator to map betwe=
en host and other containers. What you could try is starting container inst=
ances that use a (shared) network (localhost) and maybe have them operate a=
t different ports?<div><br></div><div>Just curious - what is your strategy =
for the layer between the web application and the GPU servers? These kind o=
f connections (to a shared resource with sensitive data and what not) histo=
rically can make some nervous :P</div><div><br></div><div>I think what you =
are saying is:</div><div><br></div><div>=C2=A01. user requests task on fron=
t end</div><div>=C2=A02. front end handles authentication and authorization=
</div><div>=C2=A03. front end submits job to celery</div><div>=C2=A04. cele=
ry task is a Singularity container running on GPU, and since worker =3D=3D =
container, it requires networking</div><div><br></div><div>and what I&#39;m=
 suggesting is to separate the front / back servers a bit more:</div><div><=
br></div><div><div>=C2=A01. user requests task on front end</div><div>=C2=
=A02. front end handles authentication and authorization</div><div>=C2=A03.=
 front end submits job to celery (still frontend)</div><div>=C2=A04. celery=
 worker(still frontend) is a process that finishes configuration of job (me=
mory? time? cluster? queue type?) and sends job to a back end queue (slurm,=
 sge)</div><div>=C2=A05. the slurm/sge queues are optimized for this sort o=
f thing, so you just load the singularity module, run the job, and send a s=
ignal back to the front end queue.</div></div><div><br></div><div>So a few =
notes on the above:</div><div>=C2=A0- there is flexibility (step 4) to have=
 different kinds of queues in different locations. The front end worker is =
the manager of where things go.</div><div>=C2=A0- the singularity container=
 is not required to have a network, or be constantly running.</div><div>=C2=
=A0- the main server (the same celery workers) also need a means to receive=
 messages of something finishing to update the server, this could be a POST=
 or similar.</div><div>=C2=A0- ideally you could manage slurm or sge with a=
n API.</div><div><br></div><div>I think there are two general recipes you c=
an follow here. If you go the &quot;old school HPC route&quot; then you wou=
ld do something like the above. You don&#39;t have a container cluster, you=
 have standard job managers and tools that communicate to them.=C2=A0 If yo=
u go the &quot;container cluster&quot; route then what would be needed is t=
o have orchestration defined for Singularity, and even better integration w=
ith Kubernetes. Several have talked about this but I don&#39;t see any code=
 yet :) It&#39;s a bit of a catch 22, because you could just use Docker for=
 the second, but wait you can&#39;t because Docker + HPC =3D death. You cou=
ld just use HPC technology for the first but wait you can&#39;t, because th=
at&#39;s not going to plug in easily in environments outside of HPC. So you=
r choices are to help make Singularity more enterprise/cloudy to integrate =
into container clusters, or to imagine if a more HPC-centric method could b=
e adopted in different environments. I think generally connecting protected=
 clusters to the outside world is a hard problem, take a look at Agave --&g=
t;=C2=A0<a href=3D"https://github.com/agaveapi" target=3D"_blank">https://g=
ithub.com/agaveap<wbr>i</a> for inspiration.</div><div><br></div><div>Best,=
</div><div><br></div><div>Vanessa</div><div><br></div><div><br></div><div><=
br></div></div><div class=3D"gmail-m_-8303718514757557482HOEnZb"><div class=
=3D"gmail-m_-8303718514757557482h5"><div class=3D"gmail_extra"><br><div cla=
ss=3D"gmail_quote">On Sun, Nov 26, 2017 at 8:48 AM, Dejan =C5=A0tepec <span=
 dir=3D"ltr">&lt;<a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">s=
tepec...@gmail.com</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
e" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204)=
;padding-left:1ex"><div dir=3D"auto">Frontend server probably using Flask y=
es will authenticate the user using calls to existing backend so this part =
is taken care of. After sucessfull authentication I would like to send task=
 to the task queue (celery) and one of the predefinied and started gpu work=
ers that would run on separate nodes using Singularity would take the job, =
execute it and send the results back to the frontend server which would del=
iver result back to the backend. So my only concern was if networking in Si=
ngularity supports this kind of idea ( running container as a Celery worker=
 - tcp connection to some remote queue, that maybe will also run as a Singu=
larity container). Basically is this possible?</div><div class=3D"gmail_ext=
ra"><br><div class=3D"gmail_quote">26. nov. 2017 4:32 pop. je oseba &quot;v=
&quot; &lt;<a href=3D"mailto:vso...@gmail.com" target=3D"_blank">vso...@gma=
il.com</a>&gt; napisala:<div><div class=3D"gmail-m_-8303718514757557482m_69=
31211419271720679h5"><br type=3D"attribution"><blockquote class=3D"gmail_qu=
ote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,20=
4);padding-left:1ex"><div dir=3D"ltr">oh that is super cool! If the celery =
workers are part of the web service, this is a reasonable approach I think.=
 I would use a standard (front server) set up with some application (e.g., =
django or flask driven if you are using Python) controlling / set up with a=
 queue, and instead of having the job queue living with the frontend server=
 part, I would have one async task that has the job to assess metadata (eg,=
 is this a user of cluster X? how much memory and time does it need?) to se=
nd it to your infrastructure queue (a different queue!) to first pass throu=
gh authentication, authorization, etc. Actually, you could probably also do=
 this with an internal API. I&#39;ve never tried, but it seems like it woul=
d be challenging to require the celery connected to the web application to =
actually control the nodes. If you get in some situation of wanting to add =
another set of (kind of different or external nodes) it would be hard to do=
. If each is sort of modular (meaning the celery workers have an authentica=
ted general message they can send anywhere, to multiple kinds of nodes) tha=
t seems like a good approach.</div><div class=3D"gmail_extra"><br><div clas=
s=3D"gmail_quote">On Sun, Nov 26, 2017 at 7:26 AM, Dejan =C5=A0tepec <span =
dir=3D"ltr">&lt;<a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">st=
epec...@gmail.com</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote=
" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);=
padding-left:1ex"><div dir=3D"auto">The whole thing will be part of a bigge=
r web service so this additional image processing service will get requests=
 from some backend infrastructure and this service besides compute nodes wi=
ll consist also from a server (master) that will accept remote requests (e.=
g. web sockets) and will be pushing work to a queue to Celery workers. Prob=
ably Celery is not absolutely needed but we want the service to be portable=
 not used only on HPCs but some other cluster using e.g. Kubernetes and Doc=
ker etc.</div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">26.=
 nov. 2017 4:17 pop. je oseba &quot;v&quot; &lt;<a href=3D"mailto:vso...@gm=
ail.com" target=3D"_blank">vso...@gmail.com</a>&gt; napisala:<div><div clas=
s=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-830076836819156060=
7m_1897365208364906938h5"><br type=3D"attribution"><blockquote class=3D"gma=
il_quote" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,2=
04,204);padding-left:1ex"><div dir=3D"ltr">If management of resources (node=
s) is in order, I think a proper job manager might be better fit for this j=
ob. Celery (from how I&#39;ve used it) is more appropriate for a situation =
like a web application where you want the server to have a job queue, and p=
ut tasks in it to run when there is free compute time (and to run async). T=
hey are similar because a &quot;master&quot; node maps to the broker, and t=
he &quot;slaves&quot; map to the workers. Also in my experience the workers=
 are on and ready, which would translate to having multiple container insta=
nces running and listening for tasks. Is there a reason you have preference=
 for celery instead of traditional SLURM / SGE / other? I think if you real=
ly wanted to do this fully it would be most logical to add an actual suppor=
ting plugin for singularity workers to rabbitmq:<div><br></div><div><a href=
=3D"https://pubs.vmware.com/vfabric5/index.jsp#com.vmware.vfabric.rabbitmq.=
2.4/plugin-development.html" target=3D"_blank">https://pubs.vmware.com/vfab=
ri<wbr>c5/index.jsp#com.vmware.vfabri<wbr>c.rabbitmq.2.4/plugin-developm<wb=
r>ent.html</a><br></div><div><br></div><div>Or something similar with celer=
y. Keep us in the loop!</div></div><div class=3D"gmail_extra"><br><div clas=
s=3D"gmail_quote">On Sun, Nov 26, 2017 at 12:50 AM, Dejan =C5=A0tepec <span=
 dir=3D"ltr">&lt;<a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">s=
tepec...@gmail.com</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quot=
e" style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204)=
;padding-left:1ex"><div dir=3D"auto">I intented to use multiple instances o=
f separete nodes because of heavy use of GPUs. I guess that for such usage =
there would be better to make workers completely independent as separate in=
stances of containers. The only thing that I wasn&#39;t sure of is the netw=
orking part in Singularity, meaning if we can connect to a remote queue to =
get a job.</div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">2=
6. nov. 2017 3:07 dop. je oseba &quot;v&quot; &lt;<a href=3D"mailto:vso...@=
gmail.com" target=3D"_blank">vso...@gmail.com</a>&gt; napisala:<div><div cl=
ass=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-8300768368191560=
607m_1897365208364906938m_3679851968510581478m_5093744772853157683h5"><br t=
ype=3D"attribution"><blockquote class=3D"gmail_quote" style=3D"margin:0px 0=
px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div =
dir=3D"ltr">This is a cool use case!<div><br></div><div>So I&#39;m guessing=
 the image processing app is probably in python? And you have python tasks =
defined for it? The broker is a remote queue (RabbitMQ) that would utilize =
the workers.</div><div><br></div><div>Is there a reason to have multiple in=
stances for many workers? I&#39;ve tried both, and usually the solution I p=
refer is to start a single container with concurrency (meaning multiple wor=
kers). By default the call to start the worker with celery will do the numb=
er of cores available, but you can also set it to be something different (e=
g celery -A myproject worker --concurrency=3D10...). For Singularity you wo=
uld want to have your image, and then have a startscript for it, and have t=
he startscript be this celery command to start up the (concurrent) workers.=
</div><div><br></div><div>I would start out doing the following:</div><div>=
<br></div><div>=C2=A0- create a singularity image that has a startscript wi=
th your command to start the workers</div><div>=C2=A0- start an instance</d=
iv><div>=C2=A0- set up your RabbitMQ and test sending jobs to it.</div><div=
>=C2=A0- report back!</div><div><br></div><div>Best,</div><div><br></div><d=
iv>Vanessa</div></div><div class=3D"gmail_extra"><br><div class=3D"gmail_qu=
ote">On Sat, Nov 25, 2017 at 5:10 PM, Dejan =C5=A0tepec <span dir=3D"ltr">&=
lt;<a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">stepec...@gmail=
.com</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"ma=
rgin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:=
1ex"><div dir=3D"ltr">Hi all!<div><br></div><div>As a new user of a Singula=
rity I have a question about a use case. I intend to package an image proce=
ssing app in a Singularity container but have a question about communicatio=
n between separate nodes for example using RabitMQ or to access to some rem=
ote queue. I intend to package these worker nodes as a <a href=3D"http://ww=
w.celeryproject.org/" target=3D"_blank">Celery</a> workers so I need to kno=
w if we can connect to a remote RabbitMQ queue from the Singularity contain=
er to get a new batch of data to be processed from a remote queue. I intend=
 to use Singularity as this nodes are computationally intensive and will be=
 placed at some HPC with SLURM workload manager installed of course having =
no sudo access.</div><div><br></div><div>Best regards,</div><div><br></div>=
<div>Dejan</div></div><span class=3D"gmail-m_-8303718514757557482m_69312114=
19271720679m_-8300768368191560607m_1897365208364906938m_3679851968510581478=
m_5093744772853157683m_4020543116012023696m_3780020404652605886HOEnZb"><fon=
t color=3D"#888888">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</font></span></blockquote></div><br><br clear=3D"all"><div><br></div>-- <b=
r><div class=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-8300768=
368191560607m_1897365208364906938m_3679851968510581478m_5093744772853157683=
m_4020543116012023696m_3780020404652605886gmail_signature">Vanessa Villamia=
 Sochat<br>Stanford University &#39;16<br><div><div><div><a href=3D"tel:(60=
3)%20321-0676" value=3D"+16033210676" target=3D"_blank">(603) 321-0676</a><=
/div></div></div></div>
</div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</blockquote></div></div></div></div><div class=3D"gmail-m_-830371851475755=
7482m_6931211419271720679m_-8300768368191560607m_1897365208364906938m_36798=
51968510581478m_5093744772853157683HOEnZb"><div class=3D"gmail-m_-830371851=
4757557482m_6931211419271720679m_-8300768368191560607m_1897365208364906938m=
_3679851968510581478m_5093744772853157683h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
<div class=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-830076836=
8191560607m_1897365208364906938m_3679851968510581478m_5093744772853157683gm=
ail_signature">Vanessa Villamia Sochat<br>Stanford University &#39;16<br><d=
iv><div><div><a href=3D"tel:(603)%20321-0676" value=3D"+16033210676" target=
=3D"_blank">(603) 321-0676</a></div></div></div></div>
</div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</blockquote></div></div></div></div><div class=3D"gmail-m_-830371851475755=
7482m_6931211419271720679m_-8300768368191560607m_1897365208364906938HOEnZb"=
><div class=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-83007683=
68191560607m_1897365208364906938h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
<div class=3D"gmail-m_-8303718514757557482m_6931211419271720679m_-830076836=
8191560607m_1897365208364906938gmail_signature">Vanessa Villamia Sochat<br>=
Stanford University &#39;16<br><div><div><div><a href=3D"tel:(603)%20321-06=
76" value=3D"+16033210676" target=3D"_blank">(603) 321-0676</a></div></div>=
</div></div>
</div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</blockquote></div></div></div></div><div class=3D"gmail-m_-830371851475755=
7482m_6931211419271720679HOEnZb"><div class=3D"gmail-m_-8303718514757557482=
m_6931211419271720679h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
<div class=3D"gmail-m_-8303718514757557482m_6931211419271720679gmail_signat=
ure">Vanessa Villamia Sochat<br>Stanford University &#39;16<br><div><div><d=
iv><a href=3D"tel:(603)%20321-0676" value=3D"+16033210676" target=3D"_blank=
">(603) 321-0676</a></div></div></div></div>
</div>

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.go<wbr>v</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
</div></div><div class=3D"gmail-m_-8303718514757557482gmail_signature"><div=
><blockquote style=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(20=
4,204,204);padding-left:1ex"><a href=3D"mailto:stepec...@gmail.com" target=
=3D"_blank"><font color=3D"#000000"><img src=3D"http://www.shrani.si/f/2y/i=
k/1ERvpjFq/google16.png"></font></a>=C2=A0<span style=3D"background-color:r=
gb(255,255,255)"><font color=3D"#3366FF"><font face=3D"arial, helvetica, sa=
ns-serif"><b><a href=3D"mailto:stepec...@gmail.com" target=3D"_blank">stepe=
c...@gmail.com</a></b></font></font></span></blockquote><div><blockquote st=
yle=3D"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padd=
ing-left:1ex"><a href=3D"mailto:dejan...@live.com" target=3D"_blank"><font =
color=3D"#000000"><img src=3D"http://www.shrani.si/f/3C/V7/32FZkd5D/windows=
16.png"></font></a>=C2=A0<font face=3D"arial, helvetica, sans-serif"><b><fo=
nt color=3D"#3366ff"><a href=3D"mailto:dejan...@live.com" target=3D"_blank"=
>dejan...@live.com<br><img src=3D"http://shortersigs.com/images/skype_logo.=
gif"></a>=C2=A0dejanstepec</font></b></font></blockquote></div></div></div>
</div><div class=3D"gmail-HOEnZb"><div class=3D"gmail-h5">

<p></p>

-- <br>
You received this message because you are subscribed to the Google Groups &=
quot;singularity&quot; group.<br>
To unsubscribe from this group and stop receiving emails from it, send an e=
mail to <a href=3D"mailto:singu...@lbl.gov" target=3D"_blank">singularity+u=
nsubscribe@lbl.<wbr>gov</a>.<br>
</div></div></blockquote></div><br><br clear=3D"all"><div><br></div>-- <br>=
<div class=3D"gmail_signature" data-smartmail=3D"gmail_signature">Vanessa V=
illamia Sochat<br>Stanford University &#39;16<br><div><div><div>(603) 321-0=
676</div></div></div></div>
</div></div>

--94eb2c04d376141da3055ee85ebf--
